<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜ì „í†¡ - TRPG ëª¨í—˜</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0d1421, #1a2332, #2d3748, #1a2332, #0d1421);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .world-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: all 1s ease-in-out;
            z-index: -2;
        }

        .world-background.active {
            opacity: 0.3;
        }

        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: all 1s ease-in-out;
            cursor: pointer;
        }

        .intro-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .intro-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
        }

        .intro-text {
            position: relative;
            z-index: 1001;
            text-align: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 300;
            opacity: 0.9;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header {
            background: linear-gradient(135deg, rgba(13, 20, 33, 0.95), rgba(45, 55, 72, 0.8));
            backdrop-filter: blur(20px);
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #64b3f4, #c96dd8, #f093fb, #64b3f4);
            background-size: 300% 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientText 4s ease infinite;
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 0 30px rgba(100, 179, 244, 0.5);
            margin-bottom: 0.5rem;
        }

        @keyframes gradientText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 1rem;
            padding: 1rem;
            justify-content: center;
            align-items: flex-start;
            height: calc(100vh - 120px);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.8), rgba(26, 35, 50, 0.6));
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            height: 100%;
            max-height: calc(100vh - 140px);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(100, 179, 244, 0.5) transparent;
            min-height: 0;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            border-radius: 10px;
        }

        .message {
            max-width: 85%;
            padding: 1.5rem;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.6;
            position: relative;
            animation: messageSlideIn 0.5s ease-out;
            backdrop-filter: blur(10px);
            font-size: 1rem;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.player {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 8px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .message.dm {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.9), rgba(26, 32, 44, 0.9));
            border: 1px solid rgba(100, 179, 244, 0.3);
            color: #f7fafc;
            border-bottom-left-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .message.dm::before {
            content: "ğŸ² ë˜ì „ë§ˆìŠ¤í„°";
            display: block;
            font-weight: 600;
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .message.system {
            align-self: center;
            background: linear-gradient(135deg, rgba(201, 109, 216, 0.2), rgba(100, 179, 244, 0.1));
            border: 1px solid rgba(201, 109, 216, 0.4);
            color: #f7fafc;
            border-radius: 15px;
            max-width: 90%;
            text-align: center;
        }

        .message.system::before {
            content: "âš™ï¸ ì‹œìŠ¤í…œ";
            display: block;
            font-weight: 600;
            color: #c96dd8;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .message.player::before {
            content: "âš”ï¸ ëª¨í—˜ê°€";
            display: block;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .input-area {
            flex-shrink: 0;
            padding: 2rem;
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.9), rgba(26, 35, 50, 0.7));
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid rgba(100, 179, 244, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 1rem;
            font-family: 'Noto Sans KR', sans-serif;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        #messageInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #messageInput:focus {
            outline: none;
            border-color: #64b3f4;
            box-shadow: 0 0 30px rgba(100, 179, 244, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        #sendButton {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Noto Sans KR', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        #sendButton:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        #sendButton:disabled {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .thinking {
            display: none;
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.1));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 179, 244, 0.3);
            padding: 1.5rem;
            border-radius: 20px;
            border-bottom-left-radius: 8px;
            color: #64b3f4;
            font-style: italic;
            font-weight: 500;
            margin: 0 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 0.8;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.02);
            }
        }

        .thinking.show {
            display: block;
        }

        .side-panel {
            width: 90%;
            max-width: 1200px;
            max-height: calc(100vh - 2rem);
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.9), rgba(26, 35, 50, 0.7));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            text-align: center;
        }

        .side-panel.game-mode {
            width: 320px;
            max-width: 320px;
            max-height: calc(100vh - 140px);
            padding: 2rem;
            text-align: left;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .side-panel.game-mode::-webkit-scrollbar {
            width: 6px;
        }

        .side-panel.game-mode::-webkit-scrollbar-track {
            background: transparent;
        }

        .side-panel.game-mode::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            border-radius: 10px;
        }

        .side-panel h3 {
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .session-info {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border: 1px solid rgba(100, 179, 244, 0.2);
            text-align: center;
        }

        .session-info strong {
            color: #64b3f4;
            font-weight: 600;
        }

        #sessionStatus {
            color: #f7fafc;
            font-weight: 500;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .quick-action {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 15px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quick-action:hover {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.2), rgba(201, 109, 216, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(100, 179, 244, 0.2);
            border-color: #64b3f4;
        }

        .class-selection {
            margin-bottom: 2rem;
        }

        .class-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .class-option {
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(100, 179, 244, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .class-option:hover {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.2), rgba(201, 109, 216, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(100, 179, 244, 0.2);
            border-color: #64b3f4;
        }

        .class-option.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.2));
            border-color: #667eea;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
        }

        .class-icon {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .class-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #64b3f4;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .class-desc {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            line-height: 1.4;
        }

        .world-selection {
            margin-bottom: 2rem;
        }

        .world-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .world-option {
            padding: 2rem;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            border: 3px solid rgba(100, 179, 244, 0.3);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .world-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.2;
            z-index: -1;
            transition: all 0.3s ease;
        }

        .world-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(100, 179, 244, 0.3);
            border-color: #64b3f4;
        }

        .world-option:hover::before {
            opacity: 0.4;
        }

        .world-option.selected {
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
            border-color: #667eea;
            transform: translateY(-5px);
        }

        .world-option.selected::before {
            opacity: 0.6;
        }

        .world-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .world-name {
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .world-desc {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        body.theme-apocalypse {
            --primary-color: #dc2626;
            --secondary-color: #991b1b;
            --accent-color: #fca5a5;
        }

        body.theme-fantasy {
            --primary-color: #7c3aed;
            --secondary-color: #5b21b6;
            --accent-color: #c4b5fd;
        }

        body.theme-cyberpunk {
            --primary-color: #06b6d4;
            --secondary-color: #0891b2;
            --accent-color: #67e8f9;
        }

        body.theme-modern {
            --primary-color: #059669;
            --secondary-color: #047857;
            --accent-color: #6ee7b7;
        }

        body[class*="theme-"] .header h1 {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            background-size: 300% 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        body[class*="theme-"] .message.player {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        body[class*="theme-"] .quick-action:hover,
        body[class*="theme-"] .class-option:hover,
        body[class*="theme-"] .world-option:hover {
            border-color: var(--primary-color);
            box-shadow: 0 10px 25px rgba(var(--primary-color), 0.2);
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
                height: calc(100vh - 100px);
            }
            
            .side-panel {
                width: 95%;
                margin: 0;
                padding: 2rem;
            }

            .side-panel.game-mode {
                width: 95%;
                max-width: none;
                max-height: calc(100vh - 200px);
                order: -1;
                padding: 1.5rem;
                flex-shrink: 0;
            }

            .character-panel, .inventory-panel, .quest-panel, .choices-panel {
                max-height: 250px;
            }

            .chat-area {
                max-height: calc(100vh - 300px);
                min-height: 300px;
            }

            .messages {
                padding: 1.5rem;
            }

            .input-area {
                padding: 1.5rem;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .world-options {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .world-option {
                min-height: 200px;
            }

            .world-icon {
                font-size: 3rem;
            }

            .world-name {
                font-size: 1.2rem;
            }
        }

        /* ìƒˆë¡œìš´ ê²Œì„ ì‹œìŠ¤í…œ ìŠ¤íƒ€ì¼ */
        .character-panel, .inventory-panel, .quest-panel, .choices-panel {
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.9), rgba(26, 35, 50, 0.7));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(100, 179, 244, 0.3);
            padding: 1.5rem;
            margin-bottom: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .character-panel::-webkit-scrollbar, 
        .inventory-panel::-webkit-scrollbar, 
        .quest-panel::-webkit-scrollbar, 
        .choices-panel::-webkit-scrollbar {
            width: 4px;
        }

        .character-panel::-webkit-scrollbar-track, 
        .inventory-panel::-webkit-scrollbar-track, 
        .quest-panel::-webkit-scrollbar-track, 
        .choices-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .character-panel::-webkit-scrollbar-thumb, 
        .inventory-panel::-webkit-scrollbar-thumb, 
        .quest-panel::-webkit-scrollbar-thumb, 
        .choices-panel::-webkit-scrollbar-thumb {
            background: rgba(100, 179, 244, 0.5);
            border-radius: 10px;
        }

        .character-panel h3, .inventory-panel h3, .quest-panel h3, .choices-panel h3 {
            color: #64b3f4;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.1rem;
        }

        .character-name-level {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .character-class {
            text-align: center;
            color: #c96dd8;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .stat-bars {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .stat-bar {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .stat-bar label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .bar-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bar {
            flex: 1;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .hp-bar .bar-fill {
            background: linear-gradient(90deg, #e53e3e, #fc8181);
        }

        .mp-bar .bar-fill {
            background: linear-gradient(90deg, #3182ce, #63b3ed);
        }

        .stamina-bar .bar-fill {
            background: linear-gradient(90deg, #38a169, #68d391);
        }

        .exp-bar .bar-fill {
            background: linear-gradient(90deg, #d69e2e, #f6e05e);
        }

        .bar-text {
            font-size: 0.8rem;
            min-width: 60px;
            text-align: right;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .inventory-slot:hover {
            background: rgba(100, 179, 244, 0.1);
            border-color: #64b3f4;
        }

        .equipment-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .equipment-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(100, 179, 244, 0.2);
        }

        .slot-label {
            font-weight: 600;
            color: #64b3f4;
        }

        .slot-item {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .quest-item {
            background: rgba(100, 179, 244, 0.1);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 10px;
            padding: 1rem;
        }

        .quest-title {
            font-weight: 600;
            color: #64b3f4;
            margin-bottom: 0.5rem;
        }

        .quest-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }

        .quest-progress {
            font-size: 0.8rem;
            color: #c96dd8;
        }

        .dice-result {
            position: fixed;
            top: 50%;
            right: 2rem;
            transform: translateY(-50%);
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.95), rgba(26, 35, 50, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px solid rgba(100, 179, 244, 0.5);
            padding: 2rem;
            text-align: center;
            z-index: 1500;
            animation: diceAppear 0.5s ease-out;
        }

        @keyframes diceAppear {
            from {
                opacity: 0;
                transform: translateY(-50%) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
        }

        .dice-animation {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            animation: diceRoll 1s ease-in-out;
        }

        @keyframes diceRoll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .dice-value {
            font-size: 2rem;
            font-weight: bold;
            color: #64b3f4;
            margin-bottom: 0.5rem;
        }

        .dice-type {
            font-size: 1rem;
            color: #c96dd8;
            font-weight: 600;
        }

        .dice-type.critical-success {
            color: #68d391;
        }

        .dice-type.critical-failure {
            color: #fc8181;
        }

        .choices-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .choice-option {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-option:hover {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.2), rgba(201, 109, 216, 0.1));
            border-color: #64b3f4;
            transform: translateY(-2px);
        }

        .custom-action {
            border-top: 1px solid rgba(100, 179, 244, 0.3);
            padding-top: 1rem;
        }

        .custom-action label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #64b3f4;
        }

        .custom-action input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 8px;
            color: white;
            margin-bottom: 0.5rem;
        }

        .custom-action input:focus {
            outline: none;
            border-color: #64b3f4;
            box-shadow: 0 0 10px rgba(100, 179, 244, 0.3);
        }

        .custom-action button {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .custom-action button:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="world-background" id="worldBackground"></div>

    <div class="header">
        <h1>ğŸ° ë˜ì „í†¡</h1>
        <p>AI ë˜ì „ë§ˆìŠ¤í„°ì™€ í•¨ê»˜í•˜ëŠ” TRPG ëª¨í—˜</p>
    </div>

    <div class="game-container">
        <div class="chat-area">
            <div class="messages" id="messages">
                <div class="message dm">
                    ğŸŒŸ **í™˜ì˜í•©ë‹ˆë‹¤, ìš©ê°í•œ ëª¨í—˜ê°€!**<br><br>
                    ì €ëŠ” ì—¬ëŸ¬ë¶„ì„ ë‹¤ì–‘í•œ ì„¸ê³„ë¡œ ì•ˆë‚´í•  ë˜ì „ë§ˆìŠ¤í„°ì…ë‹ˆë‹¤.<br><br>
                    
                    ìš°ì¸¡ì—ì„œ **ì„¸ê³„ê´€**ì„ ì„ íƒí•œ í›„ **ì§ì—…**ì„ ì„ íƒí•˜ë©´ ëª¨í—˜ì´ ì‹œì‘ë©ë‹ˆë‹¤!<br><br>
                    
                    ğŸŒ ì–´ë–¤ ì„¸ê³„ì—ì„œ ëª¨í—˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                </div>
            </div>
            
            <div class="thinking" id="thinking">
                ğŸ² ë˜ì „ë§ˆìŠ¤í„°ê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea id="messageInput" placeholder="ë¨¼ì € ìš°ì¸¡ì—ì„œ ì„¸ê³„ê´€ê³¼ ì§ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”..." 
                           autocomplete="off" rows="1" disabled></textarea>
                    <button id="sendButton" disabled>âœ¨ ì „ì†¡</button>
                </div>
            </div>
        </div>

        <div class="side-panel" id="sidePanel">
            <div id="worldSelection" class="world-selection">
                <h3>ğŸŒ ëª¨í—˜í•  ì„¸ê³„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
                <div class="world-options">
                    <div class="world-option" onclick="selectWorld('apocalypse')">
                        <div class="world-icon">ğŸ§Ÿ</div>
                        <div class="world-name">ì¢€ë¹„ ì•„í¬ì¹¼ë¦½ìŠ¤</div>
                        <div class="world-desc">íí—ˆê°€ ëœ ì„¸ìƒì—ì„œì˜ ìƒì¡´</div>
                    </div>
                    <div class="world-option" onclick="selectWorld('fantasy')">
                        <div class="world-icon">ğŸ°</div>
                        <div class="world-name">ì •í†µ íŒíƒ€ì§€</div>
                        <div class="world-desc">ë§ˆë²•ê³¼ ë“œë˜ê³¤ì˜ ì¤‘ì„¸ ì„¸ê³„</div>
                    </div>
                    <div class="world-option" onclick="selectWorld('cyberpunk')">
                        <div class="world-icon">ğŸ¤–</div>
                        <div class="world-name">ì‚¬ì´ë²„í‘í¬</div>
                        <div class="world-desc">ë„¤ì˜¨ì‚¬ì¸ ê°€ë“í•œ ë¯¸ë˜ ë„ì‹œ</div>
                    </div>
                    <div class="world-option" onclick="selectWorld('modern')">
                        <div class="world-icon">ğŸŒŸ</div>
                        <div class="world-name">í˜„ëŒ€ íŒíƒ€ì§€</div>
                        <div class="world-desc">í˜„ì‹¤ ì† ìˆ¨ê²¨ì§„ ë§ˆë²• ì„¸ê³„</div>
                    </div>
                </div>
            </div>

            <div id="classSelection" class="class-selection" style="display: none;">
                <h3 id="classSelectionTitle">âš”ï¸ ì§ì—… ì„ íƒ</h3>
                <div class="class-options" id="classOptions">
                    <!-- ì„¸ê³„ê´€ ì„ íƒ í›„ ë™ì ìœ¼ë¡œ ìƒì„± -->
                </div>
            </div>

            <!-- ìºë¦­í„° ì •ë³´ íŒ¨ë„ -->
            <div id="characterPanel" class="character-panel" style="display: none;">
                <h3>ğŸ‘¤ ìºë¦­í„° ì •ë³´</h3>
                <div class="character-info">
                    <div class="character-name-level">
                        <span id="characterName">ëª¨í—˜ê°€</span>
                        <span id="characterLevel">Lv.1</span>
                    </div>
                    <div class="character-class" id="characterClass">ì „ì‚¬</div>
                    
                    <!-- HP/MP/ìŠ¤íƒœë¯¸ë‚˜ ë°” -->
                    <div class="stat-bars">
                        <div class="stat-bar">
                            <label>â¤ï¸ HP</label>
                            <div class="bar-container">
                                <div class="bar hp-bar">
                                    <div class="bar-fill" id="hpFill" style="width: 100%"></div>
                                </div>
                                <span class="bar-text" id="hpText">100/100</span>
                            </div>
                        </div>
                        <div class="stat-bar">
                            <label>ğŸ’™ MP</label>
                            <div class="bar-container">
                                <div class="bar mp-bar">
                                    <div class="bar-fill" id="mpFill" style="width: 100%"></div>
                                </div>
                                <span class="bar-text" id="mpText">50/50</span>
                            </div>
                        </div>
                        <div class="stat-bar">
                            <label>ğŸ’š ì²´ë ¥</label>
                            <div class="bar-container">
                                <div class="bar stamina-bar">
                                    <div class="bar-fill" id="staminaFill" style="width: 100%"></div>
                                </div>
                                <span class="bar-text" id="staminaText">100/100</span>
                            </div>
                        </div>
                        <div class="stat-bar">
                            <label>â­ EXP</label>
                            <div class="bar-container">
                                <div class="bar exp-bar">
                                    <div class="bar-fill" id="expFill" style="width: 0%"></div>
                                </div>
                                <span class="bar-text" id="expText">0/100</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¸ë²¤í† ë¦¬ íŒ¨ë„ -->
            <div id="inventoryPanel" class="inventory-panel" style="display: none;">
                <h3>ğŸ’ ì¸ë²¤í† ë¦¬</h3>
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </div>
                <div class="equipment-slots">
                    <h4>ì¥ì°© ì•„ì´í…œ</h4>
                    <div class="equipment-grid">
                        <div class="equipment-slot" id="weaponSlot">
                            <div class="slot-label">âš”ï¸ ë¬´ê¸°</div>
                            <div class="slot-item" id="equippedWeapon">ì—†ìŒ</div>
                        </div>
                        <div class="equipment-slot" id="armorSlot">
                            <div class="slot-label">ğŸ›¡ï¸ ë°©ì–´êµ¬</div>
                            <div class="slot-item" id="equippedArmor">ì—†ìŒ</div>
                        </div>
                        <div class="equipment-slot" id="accessorySlot">
                            <div class="slot-label">ğŸ’ ì¥ì‹ êµ¬</div>
                            <div class="slot-item" id="equippedAccessory">ì—†ìŒ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í€˜ìŠ¤íŠ¸ íŒ¨ë„ -->
            <div id="questPanel" class="quest-panel" style="display: none;">
                <h3>ğŸ“œ í€˜ìŠ¤íŠ¸</h3>
                <div class="quest-list" id="questList">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                </div>
            </div>

            <!-- ì£¼ì‚¬ìœ„ ê²°ê³¼ í‘œì‹œ -->
            <div id="diceResult" class="dice-result" style="display: none;">
                <div class="dice-animation" id="diceAnimation">ğŸ²</div>
                <div class="dice-value" id="diceValue">20</div>
                <div class="dice-type" id="diceType">í¬ë¦¬í‹°ì»¬ ì„±ê³µ!</div>
            </div>

            <!-- AI ì„ íƒì§€ íŒ¨ë„ -->
            <div id="choicesPanel" class="choices-panel" style="display: none;">
                <h3>ğŸ¯ í–‰ë™ ì„ íƒ</h3>
                <div class="choices-list" id="choicesList">
                    <!-- AIê°€ ì œê³µí•˜ëŠ” ì„ íƒì§€ë“¤ -->
                </div>
                <div class="custom-action">
                    <label>ë˜ëŠ” ì§ì ‘ ì…ë ¥:</label>
                    <input type="text" id="customActionInput" placeholder="ì›í•˜ëŠ” í–‰ë™ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button onclick="submitCustomAction()">ì‹¤í–‰</button>
                </div>
            </div>

            <div id="gameActions" class="game-actions" style="display: none;">
                <h3>âš¡ ê²Œì„ ë©”ë‰´</h3>
                <div class="quick-actions">
                    <div class="quick-action" onclick="togglePanel('characterPanel')">
                        ğŸ‘¤ ìºë¦­í„°
                    </div>
                    <div class="quick-action" onclick="togglePanel('inventoryPanel')">
                        ğŸ’ ì¸ë²¤í† ë¦¬
                    </div>
                    <div class="quick-action" onclick="togglePanel('questPanel')">
                        ğŸ“œ í€˜ìŠ¤íŠ¸
                    </div>
                    <div class="quick-action" onclick="sendQuickMessage('íœ´ì‹ì„ ì·¨í•©ë‹ˆë‹¤')">
                        ğŸ˜´ íœ´ì‹
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let isWaitingForResponse = false;
        let selectedClass = null;
        let selectedWorld = null;
        
        // ê²Œì„ ìƒíƒœ ê´€ë¦¬
        let gameState = {
            character: {
                name: '',
                class: '',
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                stamina: 100,
                maxStamina: 100,
                exp: 0,
                expToNext: 100,
                stats: {
                    strength: 10,
                    dexterity: 10,
                    intelligence: 10,
                    wisdom: 10,
                    constitution: 10,
                    charisma: 10
                }
            },
            inventory: [],
            equipment: {
                weapon: null,
                armor: null,
                accessory: null
            },
            quests: [],
            inCombat: false,
            currentChoices: []
        };

        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const thinking = document.getElementById('thinking');
        const sessionStatus = document.getElementById('sessionStatus');
        const classSelection = document.getElementById('classSelection');
        const worldSelection = document.getElementById('worldSelection');
        const gameActions = document.getElementById('gameActions');
        const worldBackground = document.getElementById('worldBackground');
        const sidePanel = document.getElementById('sidePanel');
        const chatArea = document.querySelector('.chat-area');

        // ì„¸ê³„ê´€ë³„ ë°°ê²½ ì´ë¯¸ì§€ URL
        const worldBackgrounds = {
            apocalypse: '/images/apocalypse-bg.png',
            fantasy: '/images/fantasy-bg.png',
            cyberpunk: '/images/cyberpunk-bg.png',
            modern: '/images/modern-bg.png'
        };

        // ì„¸ê³„ê´€ë³„ ì§ì—… ì •ë³´
        const worldClasses = {
            apocalypse: {
                warrior: { name: 'ìƒì¡´ì', icon: 'ğŸ›¡ï¸', desc: 'ì „íˆ¬ ê²½í—˜ì´ í’ë¶€í•œ ìƒì¡´ì. ê·¼ì ‘ ë¬´ê¸°ì™€ ë°©ì–´êµ¬ì— íŠ¹í™”ë˜ì–´ ìˆìœ¼ë©°, ì¢€ë¹„ ë¬´ë¦¬ì™€ì˜ ì „íˆ¬ì—ì„œ íƒì›”í•œ ëŠ¥ë ¥ì„ ë³´ì…ë‹ˆë‹¤.' },
                mage: { name: 'ê³¼í•™ì', icon: 'ğŸ§ª', desc: 'í™”í•™ ì§€ì‹ì„ í™œìš©í•´ í­ë°œë¬¼ê³¼ ë…ì„± ë¬¼ì§ˆì„ ì œì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°©ì‚¬ëŠ¥ ì§€ì—­ì—ì„œì˜ ìƒì¡´ ëŠ¥ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.' },
                rogue: { name: 'ìŠ¤ì¹´ë²¤ì €', icon: 'ğŸ”', desc: 'íí—ˆì—ì„œ ìœ ìš©í•œ ë¬¼ê±´ì„ ì°¾ì•„ë‚´ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì€ë°€í•œ ì´ë™ê³¼ íŠ¸ë© ì œì‘ì— ëŠ¥ìˆ™í•©ë‹ˆë‹¤.' },
                cleric: { name: 'ì˜ë£Œì§„', icon: 'ğŸ¥', desc: 'ì‘ê¸‰ì²˜ì¹˜ì™€ ì‹¬ë¦¬ì  ì¹˜ë£Œì— íŠ¹í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ìƒì¡´ìë“¤ì˜ ì •ì‹ ì  ì§€ì£¼ ì—­í• ì„ í•©ë‹ˆë‹¤.' }
            },
            fantasy: {
                warrior: { name: 'ê¸°ì‚¬', icon: 'âš”ï¸', desc: 'ê²€ê³¼ ë°©íŒ¨ë¥¼ ë“  ìš©ë§¹í•œ ê¸°ì‚¬. ê°•ë ¥í•œ ë¬¼ë¦¬ ê³µê²©ë ¥ê³¼ ë†’ì€ ë°©ì–´ë ¥ì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ì „ì¥ì—ì„œ ë™ë£Œë“¤ì„ ë³´í˜¸í•©ë‹ˆë‹¤.' },
                mage: { name: 'ë§ˆë²•ì‚¬', icon: 'ğŸ”®', desc: 'ê³ ëŒ€ ë§ˆë²•ì„œë¥¼ ì—°êµ¬í•˜ëŠ” í˜„ì. ê°•ë ¥í•œ ì›ì†Œ ë§ˆë²•ì„ êµ¬ì‚¬í•˜ë©°, ì‹ ë¹„ë¡œìš´ ì§€ì‹ìœ¼ë¡œ í¼ì¦ì„ í•´ê²°í•©ë‹ˆë‹¤.' },
                rogue: { name: 'ë„ì ', icon: 'ğŸ—¡ï¸', desc: 'ê·¸ë¦¼ì ì†ì— ìˆ¨ì–´ ì ì˜ ê¸‰ì†Œë¥¼ ë…¸ë¦¬ëŠ” ì•”ì‚´ì. ë¹ ë¥¸ ì†ë„ì™€ ì€ì‹  ëŠ¥ë ¥ìœ¼ë¡œ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  í•¨ì •ì„ í•´ì œí•©ë‹ˆë‹¤.' },
                cleric: { name: 'ì„±ì§ì', icon: 'âœ¨', desc: 'ì‹ ì˜ ê°€í˜¸ë¥¼ ë°›ì€ ì„±ìŠ¤ëŸ¬ìš´ ì¹˜ìœ ì‚¬. ì‹ ì„± ë§ˆë²•ìœ¼ë¡œ ë™ë£Œë¥¼ ì¹˜ìœ í•˜ê³  ì–¸ë°ë“œë¥¼ í‡´ì¹˜í•©ë‹ˆë‹¤.' }
            },
            cyberpunk: {
                warrior: { name: 'ì‚¬ì´ë²„ ìš©ë³‘', icon: 'ğŸ¦¾', desc: 'ì‚¬ì´ë²„ë„¤í‹± ê°•í™”ë¥¼ ë°›ì€ ìš©ë³‘. ì²¨ë‹¨ ë¬´ê¸°ì™€ ì¸ê³µ ê·¼ìœ¡ìœ¼ë¡œ ê°•í™”ëœ ì‹ ì²´ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.' },
                mage: { name: 'í•´ì»¤', icon: 'ğŸ’»', desc: 'ì‚¬ì´ë²„ ê³µê°„ì„ ììœ ìì¬ë¡œ ì¡°ì‘í•©ë‹ˆë‹¤. AIì™€ ì†Œí†µí•˜ê³  ì‹œìŠ¤í…œì„ í•´í‚¹í•˜ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.' },
                rogue: { name: 'ì‚¬ì´ë²„ ë‹Œì', icon: 'ğŸ‘¤', desc: 'ê´‘í•™ ìœ„ì¥ê³¼ ì‹ ê²½ ê°„ì„­ ì„í”Œë€íŠ¸ë¥¼ ì‚¬ìš©í•´ ì™„ë²½í•œ ì€ì‹ ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.' },
                cleric: { name: 'ìŠ¤íŠ¸ë¦¬íŠ¸ ë‹¥í„°', icon: 'ğŸ§¬', desc: 'ì˜ë£Œìš© ë‚˜ë…¸ë´‡ê³¼ ë°”ì´ì˜¤ í•´í‚¹ìœ¼ë¡œ ìƒì²˜ë¥¼ ì¹˜ë£Œí•˜ê³  ë…ì†Œë¥¼ ì œê±°í•©ë‹ˆë‹¤.' }
            },
            modern: {
                warrior: { name: 'í—Œí„°', icon: 'ğŸ¯', desc: 'íŠ¹ìˆ˜ë¶€ëŒ€ ì¶œì‹ ìœ¼ë¡œ í˜„ëŒ€ ë¬´ê¸°ì™€ ì „ìˆ ì— ëŠ¥í†µí•©ë‹ˆë‹¤. ì´ˆìì—°ì  ì¡´ì¬ì™€ ë§ì„œëŠ” ì „ë¬¸ í—Œí„°ì…ë‹ˆë‹¤.' },
                mage: { name: 'ë””ì§€í„¸ ë§ˆë²•ì‚¬', icon: 'ğŸ“±', desc: 'ë„ì‹œ ì†ì— ìˆ¨ì–´ ì‚¬ëŠ” í˜„ëŒ€ì˜ ë§ˆë²•ì‚¬. ìŠ¤ë§ˆíŠ¸í°ê³¼ ì»´í“¨í„°ë¥¼ í†µí•´ ë””ì§€í„¸ ë§ˆë²•ì„ êµ¬ì‚¬í•©ë‹ˆë‹¤.' },
                rogue: { name: 'ê´´ë„', icon: 'ğŸ•µï¸', desc: 'ë„ì‹œì˜ ê·¸ë¦¼ìë¥¼ ëˆ„ë¹„ëŠ” í˜„ëŒ€ì˜ ê´´ë„. CCTVë¥¼ í”¼í•˜ê³  ë³´ì•ˆ ì‹œìŠ¤í…œì„ ë¬´ë ¥í™”í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.' },
                cleric: { name: 'ì—‘ì†Œì‹œìŠ¤íŠ¸', icon: 'ğŸ™', desc: 'ì¢…êµì  ì§€ì‹ê³¼ í˜„ëŒ€ ê¸°ìˆ ì„ ê²°í•©í•´ ì•…ë ¹ì„ í‡´ì¹˜í•©ë‹ˆë‹¤.' }
            }
        };

        // ğŸ² ì£¼ì‚¬ìœ„ ì‹œìŠ¤í…œ
        function rollDice(sides = 20) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function showDiceResult(value, type = 'normal') {
            const diceResult = document.getElementById('diceResult');
            const diceAnimation = document.getElementById('diceAnimation');
            const diceValue = document.getElementById('diceValue');
            const diceType = document.getElementById('diceType');

            diceValue.textContent = value;
            
            let resultText = '';
            let resultClass = '';
            
            if (value === 20) {
                resultText = 'í¬ë¦¬í‹°ì»¬ ì„±ê³µ!';
                resultClass = 'critical-success';
            } else if (value === 1) {
                resultText = 'í¬ë¦¬í‹°ì»¬ ì‹¤íŒ¨!';
                resultClass = 'critical-failure';
            } else if (value >= 15) {
                resultText = 'ëŒ€ì„±ê³µ!';
                resultClass = 'success';
            } else if (value >= 10) {
                resultText = 'ì„±ê³µ';
                resultClass = 'success';
            } else {
                resultText = 'ì‹¤íŒ¨';
                resultClass = 'failure';
            }
            
            diceType.textContent = resultText;
            diceType.className = `dice-type ${resultClass}`;
            
            diceResult.style.display = 'block';
            
            // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
                diceResult.style.display = 'none';
            }, 3000);
            
            return { value, type: resultClass, text: resultText };
        }

        // ğŸ“Š ìºë¦­í„° ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
        function updateCharacterStats() {
            document.getElementById('characterName').textContent = gameState.character.name || 'ëª¨í—˜ê°€';
            document.getElementById('characterLevel').textContent = `Lv.${gameState.character.level}`;
            document.getElementById('characterClass').textContent = gameState.character.class;
            
            // HP ë°” ì—…ë°ì´íŠ¸
            const hpPercentage = (gameState.character.hp / gameState.character.maxHp) * 100;
            document.getElementById('hpFill').style.width = `${hpPercentage}%`;
            document.getElementById('hpText').textContent = `${gameState.character.hp}/${gameState.character.maxHp}`;
            
            // MP ë°” ì—…ë°ì´íŠ¸
            const mpPercentage = (gameState.character.mp / gameState.character.maxMp) * 100;
            document.getElementById('mpFill').style.width = `${mpPercentage}%`;
            document.getElementById('mpText').textContent = `${gameState.character.mp}/${gameState.character.maxMp}`;
            
            // ìŠ¤íƒœë¯¸ë‚˜ ë°” ì—…ë°ì´íŠ¸
            const staminaPercentage = (gameState.character.stamina / gameState.character.maxStamina) * 100;
            document.getElementById('staminaFill').style.width = `${staminaPercentage}%`;
            document.getElementById('staminaText').textContent = `${gameState.character.stamina}/${gameState.character.maxStamina}`;
            
            // ê²½í—˜ì¹˜ ë°” ì—…ë°ì´íŠ¸
            const expPercentage = (gameState.character.exp / gameState.character.expToNext) * 100;
            document.getElementById('expFill').style.width = `${expPercentage}%`;
            document.getElementById('expText').textContent = `${gameState.character.exp}/${gameState.character.expToNext}`;
        }

        // ğŸ’ ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸
        function updateInventory() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = '';
            
            // ì¸ë²¤í† ë¦¬ ìŠ¬ë¡¯ ìƒì„± (16ê°œ ìŠ¬ë¡¯)
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                
                if (gameState.inventory[i]) {
                    const item = gameState.inventory[i];
                    slot.innerHTML = `<div style="text-align: center;">
                        <div style="font-size: 1.5rem;">${item.icon}</div>
                        <div style="font-size: 0.7rem;">${item.name}</div>
                    </div>`;
                    slot.onclick = () => useItem(i);
                } else {
                    slot.innerHTML = '<div style="opacity: 0.3;">ë¹ˆ ìŠ¬ë¡¯</div>';
                }
                
                inventoryGrid.appendChild(slot);
            }
            
            // ì¥ì°© ì•„ì´í…œ ì—…ë°ì´íŠ¸
            document.getElementById('equippedWeapon').textContent = 
                gameState.equipment.weapon ? gameState.equipment.weapon.name : 'ì—†ìŒ';
            document.getElementById('equippedArmor').textContent = 
                gameState.equipment.armor ? gameState.equipment.armor.name : 'ì—†ìŒ';
            document.getElementById('equippedAccessory').textContent = 
                gameState.equipment.accessory ? gameState.equipment.accessory.name : 'ì—†ìŒ';
        }

        // ğŸ“œ í€˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateQuests() {
            const questList = document.getElementById('questList');
            questList.innerHTML = '';
            
            if (gameState.quests.length === 0) {
                questList.innerHTML = '<div style="text-align: center; opacity: 0.6;">í˜„ì¬ ì§„í–‰ ì¤‘ì¸ í€˜ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            gameState.quests.forEach((quest, index) => {
                const questItem = document.createElement('div');
                questItem.className = 'quest-item';
                questItem.innerHTML = `
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-description">${quest.description}</div>
                    <div class="quest-progress">ì§„í–‰ë¥ : ${quest.progress}/${quest.maxProgress}</div>
                `;
                questList.appendChild(questItem);
            });
        }

        // ğŸ¯ ì„ íƒì§€ ì‹œìŠ¤í…œ
        function showChoices(choices) {
            const choicesPanel = document.getElementById('choicesPanel');
            const choicesList = document.getElementById('choicesList');
            
            choicesList.innerHTML = '';
            
            choices.forEach((choice, index) => {
                const choiceOption = document.createElement('div');
                choiceOption.className = 'choice-option';
                choiceOption.innerHTML = choice;
                choiceOption.onclick = () => selectChoice(index, choice);
                choicesList.appendChild(choiceOption);
            });
            
            gameState.currentChoices = choices;
            choicesPanel.style.display = 'block';
        }

        function selectChoice(index, choice) {
            document.getElementById('choicesPanel').style.display = 'none';
            sendMessage(choice);
        }

        function submitCustomAction() {
            const customInput = document.getElementById('customActionInput');
            const action = customInput.value.trim();
            
            if (action) {
                document.getElementById('choicesPanel').style.display = 'none';
                customInput.value = '';
                sendMessage(action);
            }
        }

        // ğŸ® íŒ¨ë„ í† ê¸€ í•¨ìˆ˜
        function togglePanel(panelId) {
            const panels = ['characterPanel', 'inventoryPanel', 'questPanel'];
            
            panels.forEach(id => {
                const panel = document.getElementById(id);
                if (id === panelId) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                } else {
                    panel.style.display = 'none';
                }
            });
        }

        // ğŸ”§ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function addItemToInventory(item) {
            for (let i = 0; i < 16; i++) {
                if (!gameState.inventory[i]) {
                    gameState.inventory[i] = item;
                    updateInventory();
                    return true;
                }
            }
            return false; // ì¸ë²¤í† ë¦¬ ê°€ë“ì°¸
        }

        function useItem(slotIndex) {
            const item = gameState.inventory[slotIndex];
            if (!item) return;
            
            // ì•„ì´í…œ ì‚¬ìš© ë¡œì§
            if (item.type === 'consumable') {
                // ì†Œëª¨í’ˆ ì‚¬ìš©
                if (item.effect === 'heal') {
                    gameState.character.hp = Math.min(gameState.character.maxHp, gameState.character.hp + item.value);
                    addMessage(`${item.name}ë¥¼ ì‚¬ìš©í•˜ì—¬ HPê°€ ${item.value} íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!`, 'system');
                }
                gameState.inventory[slotIndex] = null;
            } else if (item.type === 'equipment') {
                // ì¥ë¹„ ì•„ì´í…œ
                equipItem(item, slotIndex);
            }
            
            updateInventory();
            updateCharacterStats();
        }

        function equipItem(item, slotIndex) {
            const slot = item.slot; // 'weapon', 'armor', 'accessory'
            
            // ê¸°ì¡´ ì¥ì°© ì•„ì´í…œì´ ìˆë‹¤ë©´ ì¸ë²¤í† ë¦¬ë¡œ
            if (gameState.equipment[slot]) {
                const emptySlot = findEmptyInventorySlot();
                if (emptySlot !== -1) {
                    gameState.inventory[emptySlot] = gameState.equipment[slot];
                }
            }
            
            // ìƒˆ ì•„ì´í…œ ì¥ì°©
            gameState.equipment[slot] = item;
            gameState.inventory[slotIndex] = null;
            
            addMessage(`${item.name}ì„(ë¥¼) ì¥ì°©í–ˆìŠµë‹ˆë‹¤!`, 'system');
        }

        function findEmptyInventorySlot() {
            for (let i = 0; i < 16; i++) {
                if (!gameState.inventory[i]) return i;
            }
            return -1;
        }

        // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ì£¼ì‚¬ìœ„ ì‹œìŠ¤í…œ í†µí•©)
        async function sendMessage(message) {
            if (isWaitingForResponse || !message.trim()) return;

            // ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸° (ëª¨ë“  í–‰ë™ì— ëŒ€í•´)
            const diceRoll = rollDice(20);
            const diceResult = showDiceResult(diceRoll);
            
            isWaitingForResponse = true;
            sendButton.disabled = true;
            sendButton.textContent = 'ì „ì†¡ ì¤‘...';

            // í”Œë ˆì´ì–´ ë©”ì‹œì§€ í‘œì‹œ (ì£¼ì‚¬ìœ„ ê²°ê³¼ í¬í•¨)
            addMessage(`${message} <br><small style="color: #64b3f4;">[ì£¼ì‚¬ìœ„: ${diceRoll} - ${diceResult.text}]</small>`, 'player');
            
            // ìƒê° ì¤‘ í‘œì‹œ
            thinking.classList.add('show');
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            messageInput.value = '';
            
            try {
                const url = currentSessionId 
                    ? '/api/chat/message' 
                    : '/api/chat/start';
                
                const params = new URLSearchParams();
                
                // ê²Œì„ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ í¬í•¨ (ì£¼ì‚¬ìœ„ ê²°ê³¼ì™€ ìºë¦­í„° ìƒíƒœ í¬í•¨)
                if (selectedWorld && selectedClass) {
                    const contextMessage = `[ê²Œì„ ìƒíƒœ] 
ì„¸ê³„ê´€: ${getWorldName(selectedWorld)}
ì§ì—…: ${selectedClass}
ë ˆë²¨: ${gameState.character.level}
HP: ${gameState.character.hp}/${gameState.character.maxHp}
MP: ${gameState.character.mp}/${gameState.character.maxMp}
ì£¼ì‚¬ìœ„ ê²°ê³¼: ${diceRoll} (${diceResult.text})

í”Œë ˆì´ì–´ í–‰ë™: ${message}

ë˜ì „ë§ˆìŠ¤í„°ëŠ” ì£¼ì‚¬ìœ„ ê²°ê³¼ë¥¼ ë°˜ì˜í•˜ì—¬ ìƒí™©ì„ í•´ì„í•˜ê³ , í•„ìš”ì‹œ ìºë¦­í„° ìŠ¤íƒ¯ ë³€í™”ë‚˜ ì•„ì´í…œ íšë“, í€˜ìŠ¤íŠ¸ ì§„í–‰ ë“±ì„ JSON í˜•íƒœë¡œ ì‘ë‹µ ëì— í¬í•¨í•´ì£¼ì„¸ìš”.
ì˜ˆ: [GAME_UPDATE]{"hp": -10, "exp": +25, "item": {"name": "ì²´ë ¥ í¬ì…˜", "icon": "ğŸ§ª", "type": "consumable"}}`;
                    params.append('message', contextMessage);
                } else {
                    params.append('message', message);
                }
                
                if (currentSessionId) {
                    params.append('sessionId', currentSessionId);
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // ì„¸ì…˜ ID ì—…ë°ì´íŠ¸ (ìƒˆ ì„¸ì…˜ì¸ ê²½ìš°)
                if (!currentSessionId) {
                    currentSessionId = `session_${Date.now()}`;
                    sessionStatus.textContent = 'í™œì„± ì„¸ì…˜';
                }

                // DM ì‘ë‹µ ì²˜ë¦¬ ë° ê²Œì„ ì—…ë°ì´íŠ¸
                if (data.text) {
                    processAIResponse(data.text);
                } else {
                    addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'dm');
                }

            } catch (error) {
                console.error('Error:', error);
                
                // API í• ë‹¹ëŸ‰ ì´ˆê³¼ ì˜¤ë¥˜ ì²˜ë¦¬
                if (error.message.includes('429') || error.message.includes('quota') || error.message.includes('Too Many Requests')) {
                    addMessage('âš ï¸ **API í• ë‹¹ëŸ‰ ì´ˆê³¼**<br><br>ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ì˜ AI API ì‚¬ìš©ëŸ‰ì„ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br><br>ğŸ”„ **í•´ê²° ë°©ë²•:**<br>â€¢ ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” (ìì •ì— ë¦¬ì…‹)<br>â€¢ ë˜ëŠ” ìƒˆë¡œìš´ API í‚¤ë¡œ êµì²´ê°€ í•„ìš”í•©ë‹ˆë‹¤<br><br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”! ğŸ™', 'dm');
                } else {
                    addMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'dm');
                }
            } finally {
                isWaitingForResponse = false;
                sendButton.disabled = false;
                sendButton.textContent = 'âœ¨ ì „ì†¡';
                thinking.classList.remove('show');
            }
        }

        // ì„¸ê³„ê´€ ì´ë¦„ ë°˜í™˜ í•¨ìˆ˜
        function getWorldName(worldType) {
            const names = {
                apocalypse: 'ì¢€ë¹„ ì•„í¬ì¹¼ë¦½ìŠ¤',
                fantasy: 'ì •í†µ íŒíƒ€ì§€',
                cyberpunk: 'ì‚¬ì´ë²„í‘í¬',
                modern: 'í˜„ëŒ€ íŒíƒ€ì§€'
            };
            return names[worldType];
        }

        // AI ì‘ë‹µ ì²˜ë¦¬ (ê²Œì„ ì—…ë°ì´íŠ¸ í¬í•¨)
        function processAIResponse(responseText) {
            let displayText = responseText;
            
            // ê²Œì„ ì—…ë°ì´íŠ¸ JSON ì¶”ì¶œ (ì¤‘ì²©ëœ JSON êµ¬ì¡° ì²˜ë¦¬)
            const gameUpdateIndex = responseText.indexOf('[GAME_UPDATE]');
            if (gameUpdateIndex !== -1) {
                try {
                    // [GAME_UPDATE] ë’¤ì˜ JSON ë¶€ë¶„ ì°¾ê¸°
                    const jsonStart = gameUpdateIndex + '[GAME_UPDATE]'.length;
                    let braceCount = 0;
                    let jsonEnd = -1;
                    
                    for (let i = jsonStart; i < responseText.length; i++) {
                        if (responseText[i] === '{') {
                            braceCount++;
                        } else if (responseText[i] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                jsonEnd = i + 1;
                                break;
                            }
                        }
                    }
                    
                    if (jsonEnd !== -1) {
                        const jsonStr = responseText.substring(jsonStart, jsonEnd);
                        const gameUpdate = JSON.parse(jsonStr);
                        applyGameUpdate(gameUpdate);
                        
                        // ì‘ë‹µ í…ìŠ¤íŠ¸ì—ì„œ ê²Œì„ ì—…ë°ì´íŠ¸ ë¶€ë¶„ ì™„ì „íˆ ì œê±°
                        displayText = responseText.substring(0, gameUpdateIndex) + 
                                    responseText.substring(jsonEnd);
                        displayText = displayText.trim();
                    }
                } catch (error) {
                    console.error('ê²Œì„ ì—…ë°ì´íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', error, responseText);
                    // ì˜¤ë¥˜ ì‹œ ê°„ë‹¨í•œ ë°©ë²•ìœ¼ë¡œ ì œê±°
                    displayText = responseText.replace(/\[GAME_UPDATE\].*$/, '').trim();
                }
            }
            
            // ì„ íƒì§€ ì¶”ì¶œ
            const choicesMatch = displayText.match(/\[CHOICES\]\[(.*?)\]/);
            if (choicesMatch) {
                try {
                    const choices = JSON.parse('[' + choicesMatch[1] + ']');
                    showChoices(choices);
                    
                    // ì‘ë‹µ í…ìŠ¤íŠ¸ì—ì„œ ì„ íƒì§€ ë¶€ë¶„ ì œê±°
                    displayText = displayText.replace(/\[CHOICES\]\[.*?\]/, '').trim();
                } catch (error) {
                    console.error('ì„ íƒì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
                }
            }
            
            // ë¹ˆ ì‘ë‹µì´ ì•„ë‹ ë•Œë§Œ ë©”ì‹œì§€ ì¶”ê°€
            if (displayText && displayText.length > 0) {
                addMessage(displayText, 'dm');
            }
        }

        // ê²Œì„ ì—…ë°ì´íŠ¸ ì ìš©
        function applyGameUpdate(update) {
            let updateMessages = [];
            
            // HP ë³€í™”
            if (update.hp) {
                gameState.character.hp = Math.max(0, Math.min(gameState.character.maxHp, gameState.character.hp + update.hp));
                if (update.hp > 0) {
                    updateMessages.push(`HPê°€ ${update.hp} íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    updateMessages.push(`${Math.abs(update.hp)}ì˜ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤!`);
                }
            }
            
            // MP ë³€í™”
            if (update.mp) {
                gameState.character.mp = Math.max(0, Math.min(gameState.character.maxMp, gameState.character.mp + update.mp));
                if (update.mp > 0) {
                    updateMessages.push(`MPê°€ ${update.mp} íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    updateMessages.push(`MPë¥¼ ${Math.abs(update.mp)} ì†Œëª¨í–ˆìŠµë‹ˆë‹¤!`);
                }
            }
            
            // ê²½í—˜ì¹˜ íšë“
            if (update.exp) {
                gameState.character.exp += update.exp;
                updateMessages.push(`ê²½í—˜ì¹˜ ${update.exp}ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`);
                
                // ë ˆë²¨ì—… ì²´í¬
                if (gameState.character.exp >= gameState.character.expToNext) {
                    levelUp();
                }
            }
            
            // ì•„ì´í…œ íšë“ (ë‹¨ì¼ ì•„ì´í…œ ë˜ëŠ” ë°°ì—´ ì²˜ë¦¬)
            if (update.item) {
                const items = Array.isArray(update.item) ? update.item : [update.item];
                
                items.forEach(item => {
                    if (addItemToInventory(item)) {
                        updateMessages.push(`${item.name}ì„(ë¥¼) íšë“í–ˆìŠµë‹ˆë‹¤!`);
                    } else {
                        updateMessages.push(`ì¸ë²¤í† ë¦¬ê°€ ê°€ë“ ì°¨ì„œ ${item.name}ì„(ë¥¼) íšë“í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
                    }
                });
            }
            
            // í€˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            if (update.quest) {
                if (update.quest.new) {
                    gameState.quests.push(update.quest.new);
                    updateMessages.push(`ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸: ${update.quest.new.title}`);
                }
                if (update.quest.complete) {
                    gameState.quests = gameState.quests.filter(q => q.id !== update.quest.complete);
                    updateMessages.push(`í€˜ìŠ¤íŠ¸ ì™„ë£Œ!`);
                }
            }
            
            // ì—…ë°ì´íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
            if (updateMessages.length > 0) {
                addMessage(`ğŸ“Š **ê²Œì„ ì—…ë°ì´íŠ¸**<br>${updateMessages.join('<br>')}`, 'system');
            }
            
            // UI ì—…ë°ì´íŠ¸
            updateCharacterStats();
            updateInventory();
            updateQuests();
        }

        // ë ˆë²¨ì—… ì²˜ë¦¬
        function levelUp() {
            gameState.character.level++;
            gameState.character.exp -= gameState.character.expToNext;
            gameState.character.expToNext = Math.floor(gameState.character.expToNext * 1.5);
            
            // ìŠ¤íƒ¯ ì¦ê°€
            gameState.character.maxHp += 20;
            gameState.character.hp = gameState.character.maxHp; // ë ˆë²¨ì—… ì‹œ ì²´ë ¥ ì™„ì „ íšŒë³µ
            gameState.character.maxMp += 10;
            gameState.character.mp = gameState.character.maxMp;
            
            addMessage(`ğŸ‰ **ë ˆë²¨ì—…!** Lv.${gameState.character.level}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!<br>HPì™€ MPê°€ ì™„ì „íˆ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤!`, 'system');
        }

        // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // ì¤„ë°”ê¿ˆ ì²˜ë¦¬ ë° ë¬¸ë‹¨ ë‚˜ëˆ„ê¸°
            const formattedText = text
                .replace(/\n/g, '<br>')
                .replace(/\. ([A-Zê°€-í£])/g, '.<br><br>$1')
                .replace(/([?!]) ([A-Zê°€-í£])/g, '$1<br><br>$2');
            
            messageDiv.innerHTML = formattedText;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // ë¹ ë¥¸ ë©”ì‹œì§€ ì „ì†¡
        function sendQuickMessage(message) {
            if (!isWaitingForResponse) {
                messageInput.value = message;
                sendMessage(message);
            }
        }

        // ì„¸ê³„ê´€ ì„ íƒ í•¨ìˆ˜
        function selectWorld(worldType) {
            selectedWorld = worldType;
            
            // ëª¨ë“  ì„¸ê³„ê´€ ì˜µì…˜ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.world-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // ì„ íƒëœ ì„¸ê³„ê´€ì— selected í´ë˜ìŠ¤ ì¶”ê°€
            event.target.closest('.world-option').classList.add('selected');
            
            // í…Œë§ˆ ë³€ê²½
            document.body.className = `theme-${worldType}`;
            
            // ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½
            worldBackground.style.backgroundImage = `url(${worldBackgrounds[worldType]})`;
            worldBackground.classList.add('active');
            
            // ì„¸ê³„ê´€ ì„ íƒ í›„ ì§ì—… ì„ íƒìœ¼ë¡œ ì´ë™
            setTimeout(() => {
                worldSelection.style.display = 'none';
                showClassSelection(worldType);
            }, 500);
        }

        // ì„¸ê³„ê´€ë³„ ì§ì—… ì„ íƒ UI ìƒì„±
        function showClassSelection(worldType) {
            const classes = worldClasses[worldType];
            const classOptions = document.getElementById('classOptions');
            const title = document.getElementById('classSelectionTitle');
            
            // ì„¸ê³„ê´€ì— ë§ëŠ” íƒ€ì´í‹€ ì„¤ì •
            const worldNames = {
                apocalypse: 'ğŸ§Ÿ ìƒì¡´ì ì§ì—… ì„ íƒ',
                fantasy: 'ğŸ° ëª¨í—˜ê°€ ì§ì—… ì„ íƒ', 
                cyberpunk: 'ğŸ¤– ì‚¬ì´ë²„ ì§ì—… ì„ íƒ',
                modern: 'ğŸŒŸ í˜„ëŒ€ ì§ì—… ì„ íƒ'
            };
            title.textContent = worldNames[worldType];
            
            // ì§ì—… ì˜µì…˜ ë™ì  ìƒì„±
            classOptions.innerHTML = '';
            Object.keys(classes).forEach(classKey => {
                const classInfo = classes[classKey];
                const classOption = document.createElement('div');
                classOption.className = 'class-option';
                classOption.onclick = () => selectClass(classKey, classInfo.name);
                
                classOption.innerHTML = `
                    <div class="class-icon">${classInfo.icon}</div>
                    <div class="class-name">${classInfo.name}</div>
                    <div class="class-desc">${classInfo.desc}</div>
                `;
                
                classOptions.appendChild(classOption);
            });
            
            classSelection.style.display = 'block';
        }

        // ì§ì—… ì„ íƒ í•¨ìˆ˜
        function selectClass(classKey, className) {
            selectedClass = className;
            
            // ëª¨ë“  ì§ì—… ì˜µì…˜ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.class-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // ì„ íƒëœ ì§ì—…ì— selected í´ë˜ìŠ¤ ì¶”ê°€
            event.target.closest('.class-option').classList.add('selected');
            
            // ì§ì—… ì„ íƒ í›„ ë°”ë¡œ ê²Œì„ ì‹œì‘
            setTimeout(() => {
                startGame(classKey, className);
            }, 300);
        }

        // ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startGame(classKey, className) {
            const classInfo = worldClasses[selectedWorld][classKey];
            
            // ì„¸ê³„ê´€ ì´ë¯¸ì§€ ì „ì²´í™”ë©´ìœ¼ë¡œ 7ì´ˆ í‘œì‹œ
            showWorldIntroScreen(classKey, className, classInfo);
        }

        // ì„¸ê³„ê´€ ì†Œê°œ í™”ë©´ í‘œì‹œ
        function showWorldIntroScreen(classKey, className, classInfo) {
            // ì „ì²´í™”ë©´ ì˜¤ë²„ë ˆì´ ìƒì„±
            const introOverlay = document.createElement('div');
            introOverlay.className = 'world-intro-overlay';
            introOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url(${worldBackgrounds[selectedWorld]});
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
            `;

            // ì˜¤ë²„ë ˆì´ ë‚´ìš©
            const introContent = document.createElement('div');
            introContent.style.cssText = `
                text-align: center;
                background: rgba(0, 0, 0, 0.7);
                padding: 3rem;
                border-radius: 20px;
                backdrop-filter: blur(10px);
                color: white;
                max-width: 600px;
            `;
            
            introContent.innerHTML = `
                <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: #64b3f4;">
                    ${getWorldName(selectedWorld)}
                </h2>
                <p style="font-size: 1.2rem; margin-bottom: 2rem; line-height: 1.6;">
                    ${getWorldIntroduction(selectedWorld)}
                </p>
                <div style="font-size: 1.5rem; color: #c96dd8;">
                    ì§ì—…: ${className}
                </div>
                <div style="margin-top: 2rem; font-size: 1rem; opacity: 0.8;">
                    ëª¨í—˜ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤...
                </div>
            `;

            introOverlay.appendChild(introContent);
            document.body.appendChild(introOverlay);

            // í˜ì´ë“œ ì¸
            setTimeout(() => {
                introOverlay.style.opacity = '1';
            }, 100);

            // 7ì´ˆ í›„ ê²Œì„ ì‹œì‘
            setTimeout(() => {
                // í˜ì´ë“œ ì•„ì›ƒ
                introOverlay.style.opacity = '0';
                
                setTimeout(() => {
                    document.body.removeChild(introOverlay);
                    startGameAfterIntro(classKey, className, classInfo);
                }, 500);
            }, 7000);
        }

        // ì†Œê°œ í™”ë©´ í›„ ì‹¤ì œ ê²Œì„ ì‹œì‘
        function startGameAfterIntro(classKey, className, classInfo) {
            // ìºë¦­í„° ì •ë³´ ì´ˆê¸°í™”
            initializeCharacter(className, classInfo);
            
            // ë ˆì´ì•„ì›ƒì„ ê²Œì„ ëª¨ë“œë¡œ ë³€ê²½
            sidePanel.classList.add('game-mode');
            
            // ì‚¬ì´ë“œ íŒ¨ë„ ë‚´ìš© ë³€ê²½
            classSelection.style.display = 'none';
            document.getElementById('characterPanel').style.display = 'block';
            gameActions.style.display = 'block';
            
            // ì…ë ¥ì°½ í™œì„±í™”
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = "ë˜ì „ë§ˆìŠ¤í„°ì—ê²Œ ë§ì„ ê±¸ì–´ë³´ì„¸ìš”... (ì˜ˆ: ì£¼ë³€ì„ ì‚´í´ë´…ë‹ˆë‹¤)";
            messageInput.focus();
            
            // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            messagesContainer.innerHTML = `
                <div class="message dm">
                    ğŸ² ë˜ì „ë§ˆìŠ¤í„°ê°€ ${getWorldName(selectedWorld)} ì„¸ê³„ë¥¼ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤...<br>
                    ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
                </div>
            `;
            
            // ì´ˆê¸° ì•„ì´í…œ ì§€ê¸‰
            giveStartingItems(selectedWorld, classKey);
            
            // UI ì—…ë°ì´íŠ¸
            updateCharacterStats();
            updateInventory();
            updateQuests();
            
            // AIì—ê²Œ ê²Œì„ ì‹œì‘í•˜ë¼ê³  ìš”ì²­í•˜ê³  ì‹¤ì œ ì‘ë‹µ ë°›ê¸°
            setTimeout(() => {
                startGameWithAI(className, classInfo);
            }, 500);
        }

        // ìºë¦­í„° ì´ˆê¸°í™”
        function initializeCharacter(className, classInfo) {
            gameState.character.name = 'ëª¨í—˜ê°€';
            gameState.character.class = className;
            gameState.character.level = 1;
            gameState.character.hp = 100;
            gameState.character.maxHp = 100;
            gameState.character.mp = 50;
            gameState.character.maxMp = 50;
            gameState.character.stamina = 100;
            gameState.character.maxStamina = 100;
            gameState.character.exp = 0;
            gameState.character.expToNext = 100;
        }

        // ì‹œì‘ ì•„ì´í…œ ì§€ê¸‰
        function giveStartingItems(worldType, classKey) {
            const startingItems = {
                apocalypse: {
                    warrior: [
                        { name: 'ì‘ê¸‰ì²˜ì¹˜ í‚¤íŠ¸', icon: 'ğŸ¥', type: 'consumable', effect: 'heal', value: 30 },
                        { name: 'ë…¹ìŠ¨ ì¹¼', icon: 'ğŸ—¡ï¸', type: 'equipment', slot: 'weapon', damage: 15 }
                    ],
                    mage: [
                        { name: 'ì—ë„ˆì§€ ë“œë§í¬', icon: 'âš¡', type: 'consumable', effect: 'mp', value: 20 },
                        { name: 'í™”í•™ ì¥ë¹„', icon: 'ğŸ§ª', type: 'equipment', slot: 'weapon', damage: 12 }
                    ],
                    rogue: [
                        { name: 'ì²´ë ¥ í¬ì…˜', icon: 'â¤ï¸', type: 'consumable', effect: 'heal', value: 25 },
                        { name: 'ë‹¤ëª©ì  ë„êµ¬', icon: 'ğŸ”§', type: 'equipment', slot: 'weapon', damage: 10 }
                    ],
                    cleric: [
                        { name: 'ì˜ë£Œìš© ë¶•ëŒ€', icon: 'ğŸ©¹', type: 'consumable', effect: 'heal', value: 40 },
                        { name: 'ì˜ë£Œ ê°€ë°©', icon: 'ğŸ’Š', type: 'equipment', slot: 'accessory', bonus: 'healing+5' }
                    ]
                },
                fantasy: {
                    warrior: [
                        { name: 'ì²´ë ¥ í¬ì…˜', icon: 'â¤ï¸', type: 'consumable', effect: 'heal', value: 30 },
                        { name: 'ì²  ê²€', icon: 'âš”ï¸', type: 'equipment', slot: 'weapon', damage: 20 }
                    ],
                    mage: [
                        { name: 'ë§ˆë‚˜ í¬ì…˜', icon: 'ğŸ’™', type: 'consumable', effect: 'mp', value: 25 },
                        { name: 'ë§ˆë²• ì§€íŒ¡ì´', icon: 'ğŸª„', type: 'equipment', slot: 'weapon', damage: 15, magic: true }
                    ],
                    rogue: [
                        { name: 'í•´ë…ì œ', icon: 'ğŸ§ª', type: 'consumable', effect: 'heal', value: 20 },
                        { name: 'ë‹¨ê²€', icon: 'ğŸ—¡ï¸', type: 'equipment', slot: 'weapon', damage: 18, speed: true }
                    ],
                    cleric: [
                        { name: 'ì„±ìˆ˜', icon: 'ğŸ’§', type: 'consumable', effect: 'heal', value: 35 },
                        { name: 'ì„±ìŠ¤ëŸ¬ìš´ ë¶€ì ', icon: 'ğŸ“¿', type: 'equipment', slot: 'accessory', bonus: 'protection+3' }
                    ]
                }
            };

            // ê¸°ë³¸ ì•„ì´í…œ (ëª¨ë“  ì§ì—… ê³µí†µ)
            addItemToInventory({ name: 'ë¹µ', icon: 'ğŸ', type: 'consumable', effect: 'heal', value: 15 });
            
            // ì„¸ê³„ê´€ê³¼ ì§ì—…ë³„ ì‹œì‘ ì•„ì´í…œ
            if (startingItems[worldType] && startingItems[worldType][classKey]) {
                startingItems[worldType][classKey].forEach(item => {
                    addItemToInventory(item);
                });
            }
        }

        // AIì™€ í•¨ê»˜ ê²Œì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜ 
        async function startGameWithAI(className, classInfo) {
            const startMessage = `[ê²Œì„ ì‹œì‘] ì„¸ê³„ê´€: ${getWorldName(selectedWorld)}, í”Œë ˆì´ì–´ ì§ì—…: ${className}, ì§ì—… ëŠ¥ë ¥: ${classInfo.desc}. 

ì§€ê¸ˆë¶€í„° ì´ ì„¤ì •ì— ë§ëŠ” TRPG ë˜ì „ë§ˆìŠ¤í„°ê°€ ë˜ì–´ì£¼ì„¸ìš”. í”Œë ˆì´ì–´ë¥¼ í™˜ì˜í•˜ê³  í˜„ì¬ ìƒí™©ì„ ìƒìƒí•˜ê²Œ ë¬˜ì‚¬í•˜ë©° ëª¨í—˜ì„ ì‹œì‘í•´ì£¼ì„¸ìš”. í”Œë ˆì´ì–´ê°€ ì–´ë–¤ í–‰ë™ì„ í• ì§€ ë¬¼ì–´ë³´ì„¸ìš”.`;

            try {
                const url = '/api/chat/start';
                const params = new URLSearchParams();
                params.append('message', startMessage);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // ì„¸ì…˜ ID ìƒì„±
                currentSessionId = `session_${Date.now()}`;
                
                // AI ì‘ë‹µì„ í™”ë©´ì— í‘œì‹œ
                messagesContainer.innerHTML = '';
                if (data.text) {
                    addMessage(data.text, 'dm');
                } else {
                    addMessage('ë˜ì „ë§ˆìŠ¤í„°ê°€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'dm');
                }

            } catch (error) {
                console.error('Game start error:', error);
                
                // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ
                messagesContainer.innerHTML = '';
                if (error.message.includes('429') || error.message.includes('quota')) {
                    addMessage('âš ï¸ **API í• ë‹¹ëŸ‰ ì´ˆê³¼**<br><br>ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ëŠ˜ì˜ AI API ì‚¬ìš©ëŸ‰ì„ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br><br>ğŸ”„ **í•´ê²° ë°©ë²•:**<br>â€¢ ë‚´ì¼ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš” (ìì •ì— ë¦¬ì…‹)<br>â€¢ ë˜ëŠ” ìƒˆë¡œìš´ API í‚¤ë¡œ êµì²´ê°€ í•„ìš”í•©ë‹ˆë‹¤<br><br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”! ğŸ™', 'dm');
                } else {
                    addMessage('ë˜ì „ë§ˆìŠ¤í„° ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'dm');
                }
            }
        }

        // ì„¸ê³„ê´€ë³„ ì†Œê°œ í…ìŠ¤íŠ¸
        function getWorldIntroduction(worldType) {
            const introductions = {
                apocalypse: 'í•µì „ìŸ ì´í›„ 20ë…„ì´ ì§€ë‚œ í™©íí•œ ì„¸ìƒì…ë‹ˆë‹¤. ì¢€ë¹„ë“¤ì´ ê±°ë¦¬ë¥¼ ë°°íšŒí•˜ê³ , ìƒì¡´ìë“¤ì€ íí—ˆ ì†ì—ì„œ í•˜ë£¨í•˜ë£¨ë¥¼ ë²„í…¨ë‚˜ê°€ê³  ìˆìŠµë‹ˆë‹¤.',
                fantasy: 'ë§ˆë²•ê³¼ ê²€ì´ ì§€ë°°í•˜ëŠ” ì¤‘ì„¸ íŒíƒ€ì§€ ì„¸ê³„ì…ë‹ˆë‹¤. ìš©ë“¤ì´ í•˜ëŠ˜ì„ ë‚ ê³ , ê³ ëŒ€ì˜ ë§ˆë²•ì´ ì‚´ì•„ ìˆ¨ì‰¬ëŠ” ì‹ ë¹„ë¡œìš´ ë•…ì…ë‹ˆë‹¤.',
                cyberpunk: '2085ë…„ ë„¤ì˜¤ ë„ì¿„ì…ë‹ˆë‹¤. ê±°ëŒ€ ê¸°ì—…ë“¤ì´ ì„¸ìƒì„ ì§€ë°°í•˜ê³ , ì‚¬ì´ë²„ ê³µê°„ê³¼ í˜„ì‹¤ì˜ ê²½ê³„ê°€ ëª¨í˜¸í•œ ë¯¸ë˜ ë„ì‹œì…ë‹ˆë‹¤.',
                modern: 'ê²‰ë³´ê¸°ì—” í‰ë²”í•œ í˜„ëŒ€ ë„ì‹œì´ì§€ë§Œ, ê·¸ ì´ë©´ì—ëŠ” ì´ˆìì—°ì ì¸ ì¡´ì¬ë“¤ê³¼ ìˆ¨ê²¨ì§„ ë§ˆë²• ì„¸ê³„ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.'
            };
            return introductions[worldType];
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¸ê³„ê´€ ë°°ê²½ ì´ë¯¸ì§€ ì„¤ì •
        function initializeWorldOptions() {
            const worldOptions = document.querySelectorAll('.world-option');
            worldOptions.forEach((option, index) => {
                const worldTypes = ['apocalypse', 'fantasy', 'cyberpunk', 'modern'];
                const worldType = worldTypes[index];
                if (worldBackgrounds[worldType]) {
                    option.style.setProperty('--bg-image', `url(${worldBackgrounds[worldType]})`);
                    option.addEventListener('mouseenter', () => {
                        option.style.backgroundImage = `url(${worldBackgrounds[worldType]})`;
                        option.style.backgroundSize = 'cover';
                        option.style.backgroundPosition = 'center';
                        option.style.backgroundBlendMode = 'overlay';
                    });
                    option.addEventListener('mouseleave', () => {
                        if (!option.classList.contains('selected')) {
                            option.style.backgroundImage = '';
                        }
                    });
                }
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        sendButton.addEventListener('click', () => {
            sendMessage(messageInput.value);
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(messageInput.value);
            }
        });

        // ìë™ ë†’ì´ ì¡°ì ˆ
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            initializeWorldOptions();
            // ê²Œì„ ì‹œì‘ í›„ì—ë§Œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
        });
    </script>
</body>
</html>