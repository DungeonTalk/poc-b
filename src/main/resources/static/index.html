<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎçòÏ†ÑÌÜ° - TRPG Î™®Ìóò</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Orbitron:wght@400;700;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0d1421, #1a2332, #2d3748, #1a2332, #0d1421);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: #ffffff;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .world-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0;
            transition: all 1s ease-in-out;
            z-index: -2;
        }

        .world-background.active {
            opacity: 0.3;
        }

        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: all 1s ease-in-out;
            cursor: pointer;
        }

        .intro-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .intro-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
        }

        .intro-text {
            position: relative;
            z-index: 1001;
            text-align: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 300;
            opacity: 0.9;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header {
            background: linear-gradient(135deg, rgba(13, 20, 33, 0.95), rgba(45, 55, 72, 0.8));
            backdrop-filter: blur(20px);
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #64b3f4, #c96dd8, #f093fb, #64b3f4);
            background-size: 300% 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientText 4s ease infinite;
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 0 30px rgba(100, 179, 244, 0.5);
            margin-bottom: 0.5rem;
        }

        @keyframes gradientText {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 1rem;
            padding: 1rem;
            justify-content: center;
            align-items: flex-start;
            height: calc(100vh - 120px);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.8), rgba(26, 35, 50, 0.6));
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            height: 100%;
            max-height: calc(100vh - 140px);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(100, 179, 244, 0.5) transparent;
            min-height: 0;
        }

        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            border-radius: 10px;
        }

        .message {
            max-width: 85%;
            padding: 1.5rem;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.6;
            position: relative;
            animation: messageSlideIn 0.5s ease-out;
            backdrop-filter: blur(10px);
            font-size: 1rem;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.player {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 8px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .message.dm {
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.9), rgba(26, 32, 44, 0.9));
            border: 1px solid rgba(100, 179, 244, 0.3);
            color: #f7fafc;
            border-bottom-left-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .message.dm::before {
            content: "üé≤ ÎçòÏ†ÑÎßàÏä§ÌÑ∞";
            display: block;
            font-weight: 600;
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .message.system {
            align-self: center;
            background: linear-gradient(135deg, rgba(201, 109, 216, 0.2), rgba(100, 179, 244, 0.1));
            border: 1px solid rgba(201, 109, 216, 0.4);
            color: #f7fafc;
            border-radius: 15px;
            max-width: 90%;
            text-align: center;
        }

        .message.system::before {
            content: "‚öôÔ∏è ÏãúÏä§ÌÖú";
            display: block;
            font-weight: 600;
            color: #c96dd8;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .message.player::before {
            content: "‚öîÔ∏è Î™®ÌóòÍ∞Ä";
            display: block;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .input-area {
            flex-shrink: 0;
            padding: 2rem;
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.9), rgba(26, 35, 50, 0.7));
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid rgba(100, 179, 244, 0.3);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 1rem;
            font-family: 'Noto Sans KR', sans-serif;
            transition: all 0.3s ease;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        #messageInput::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        #messageInput:focus {
            outline: none;
            border-color: #64b3f4;
            box-shadow: 0 0 30px rgba(100, 179, 244, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        #sendButton {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Noto Sans KR', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        #sendButton:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        #sendButton:disabled {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .thinking {
            display: none;
            align-self: flex-start;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.1));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 179, 244, 0.3);
            padding: 1.5rem;
            border-radius: 20px;
            border-bottom-left-radius: 8px;
            color: #64b3f4;
            font-style: italic;
            font-weight: 500;
            margin: 0 2rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 0.8;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.02);
            }
        }

        .thinking.show {
            display: block;
        }

        .side-panel {
            width: 90%;
            max-width: 1200px;
            max-height: calc(100vh - 2rem);
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.9), rgba(26, 35, 50, 0.7));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 3rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            text-align: center;
        }

        .side-panel.game-mode {
            width: 320px;
            max-width: 320px;
            max-height: calc(100vh - 140px);
            padding: 2rem;
            text-align: left;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .side-panel.game-mode::-webkit-scrollbar {
            width: 6px;
        }

        .side-panel.game-mode::-webkit-scrollbar-track {
            background: transparent;
        }

        .side-panel.game-mode::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            border-radius: 10px;
        }

        .side-panel h3 {
            background: linear-gradient(135deg, #64b3f4, #c96dd8);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }

        .session-info {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            border: 1px solid rgba(100, 179, 244, 0.2);
            text-align: center;
        }

        .session-info strong {
            color: #64b3f4;
            font-weight: 600;
        }

        #sessionStatus {
            color: #f7fafc;
            font-weight: 500;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .quick-action {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 15px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quick-action:hover {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.2), rgba(201, 109, 216, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(100, 179, 244, 0.2);
            border-color: #64b3f4;
        }

        .class-selection {
            margin-bottom: 2rem;
        }

        .class-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .class-option {
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(100, 179, 244, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .class-option:hover {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.2), rgba(201, 109, 216, 0.1));
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(100, 179, 244, 0.2);
            border-color: #64b3f4;
        }

        .class-option.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.2));
            border-color: #667eea;
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
        }

        .class-icon {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .class-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #64b3f4;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .class-desc {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            line-height: 1.4;
        }

        .world-selection {
            margin-bottom: 2rem;
        }

        .world-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .world-option {
            padding: 2rem;
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            backdrop-filter: blur(10px);
            border: 3px solid rgba(100, 179, 244, 0.3);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .world-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.2;
            z-index: -1;
            transition: all 0.3s ease;
        }

        .world-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(100, 179, 244, 0.3);
            border-color: #64b3f4;
        }

        .world-option:hover::before {
            opacity: 0.4;
        }

        .world-option.selected {
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
            border-color: #667eea;
            transform: translateY(-5px);
        }

        .world-option.selected::before {
            opacity: 0.6;
        }

        .world-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .world-name {
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .world-desc {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        body.theme-apocalypse {
            --primary-color: #dc2626;
            --secondary-color: #991b1b;
            --accent-color: #fca5a5;
        }

        body.theme-fantasy {
            --primary-color: #7c3aed;
            --secondary-color: #5b21b6;
            --accent-color: #c4b5fd;
        }

        body.theme-cyberpunk {
            --primary-color: #06b6d4;
            --secondary-color: #0891b2;
            --accent-color: #67e8f9;
        }

        body.theme-modern {
            --primary-color: #059669;
            --secondary-color: #047857;
            --accent-color: #6ee7b7;
        }

        body[class*="theme-"] .header h1 {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            background-size: 300% 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        body[class*="theme-"] .message.player {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        body[class*="theme-"] .quick-action:hover,
        body[class*="theme-"] .class-option:hover,
        body[class*="theme-"] .world-option:hover {
            border-color: var(--primary-color);
            box-shadow: 0 10px 25px rgba(var(--primary-color), 0.2);
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem;
                height: calc(100vh - 100px);
            }
            
            .side-panel {
                width: 95%;
                margin: 0;
                padding: 2rem;
            }

            .side-panel.game-mode {
                width: 95%;
                max-width: none;
                max-height: calc(100vh - 200px);
                order: -1;
                padding: 1.5rem;
                flex-shrink: 0;
            }

            .character-panel, .inventory-panel, .quest-panel, .choices-panel {
                max-height: 250px;
            }

            .chat-area {
                max-height: calc(100vh - 300px);
                min-height: 300px;
            }

            .messages {
                padding: 1.5rem;
            }

            .input-area {
                padding: 1.5rem;
            }

            .header {
                padding: 1.5rem 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .world-options {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .world-option {
                min-height: 200px;
            }

            .world-icon {
                font-size: 3rem;
            }

            .world-name {
                font-size: 1.2rem;
            }
        }

        /* ÏÉàÎ°úÏö¥ Í≤åÏûÑ ÏãúÏä§ÌÖú Ïä§ÌÉÄÏùº */
        .character-panel, .inventory-panel, .quest-panel, .choices-panel {
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.9), rgba(26, 35, 50, 0.7));
            backdrop-filter: blur(15px);
            border-radius: 15px;
            border: 1px solid rgba(100, 179, 244, 0.3);
            padding: 1.5rem;
            margin-bottom: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .character-panel::-webkit-scrollbar, 
        .inventory-panel::-webkit-scrollbar, 
        .quest-panel::-webkit-scrollbar, 
        .choices-panel::-webkit-scrollbar {
            width: 4px;
        }

        .character-panel::-webkit-scrollbar-track, 
        .inventory-panel::-webkit-scrollbar-track, 
        .quest-panel::-webkit-scrollbar-track, 
        .choices-panel::-webkit-scrollbar-track {
            background: transparent;
        }

        .character-panel::-webkit-scrollbar-thumb, 
        .inventory-panel::-webkit-scrollbar-thumb, 
        .quest-panel::-webkit-scrollbar-thumb, 
        .choices-panel::-webkit-scrollbar-thumb {
            background: rgba(100, 179, 244, 0.5);
            border-radius: 10px;
        }

        .character-panel h3, .inventory-panel h3, .quest-panel h3, .choices-panel h3 {
            color: #64b3f4;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.1rem;
        }

        .character-name-level {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .character-class {
            text-align: center;
            color: #c96dd8;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .stat-bars {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .stat-bar {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .stat-bar label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .bar-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bar {
            flex: 1;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .hp-bar .bar-fill {
            background: linear-gradient(90deg, #e53e3e, #fc8181);
        }

        .mp-bar .bar-fill {
            background: linear-gradient(90deg, #3182ce, #63b3ed);
        }

        .stamina-bar .bar-fill {
            background: linear-gradient(90deg, #38a169, #68d391);
        }

        .exp-bar .bar-fill {
            background: linear-gradient(90deg, #d69e2e, #f6e05e);
        }

        .bar-text {
            font-size: 0.8rem;
            min-width: 60px;
            text-align: right;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .inventory-slot:hover {
            background: rgba(100, 179, 244, 0.1);
            border-color: #64b3f4;
        }

        .equipment-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .equipment-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(100, 179, 244, 0.2);
        }

        .slot-label {
            font-weight: 600;
            color: #64b3f4;
        }

        .slot-item {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .quest-item {
            background: rgba(100, 179, 244, 0.1);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 10px;
            padding: 1rem;
        }

        .quest-title {
            font-weight: 600;
            color: #64b3f4;
            margin-bottom: 0.5rem;
        }

        .quest-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
        }

        .quest-progress {
            font-size: 0.8rem;
            color: #c96dd8;
        }

        .dice-result {
            position: fixed;
            top: 50%;
            right: 2rem;
            transform: translateY(-50%);
            background: linear-gradient(145deg, rgba(13, 20, 33, 0.95), rgba(26, 35, 50, 0.9));
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 2px solid rgba(100, 179, 244, 0.5);
            padding: 2rem;
            text-align: center;
            z-index: 1500;
            animation: diceAppear 0.5s ease-out;
        }

        @keyframes diceAppear {
            from {
                opacity: 0;
                transform: translateY(-50%) scale(0.5);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) scale(1);
            }
        }

        .dice-animation {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            animation: diceRoll 1s ease-in-out;
        }

        @keyframes diceRoll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }

        .dice-value {
            font-size: 2rem;
            font-weight: bold;
            color: #64b3f4;
            margin-bottom: 0.5rem;
        }

        .dice-type {
            font-size: 1rem;
            color: #c96dd8;
            font-weight: 600;
        }

        .dice-type.critical-success {
            color: #68d391;
        }

        .dice-type.critical-failure {
            color: #fc8181;
        }

        .choices-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .choice-option {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.1), rgba(201, 109, 216, 0.05));
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 10px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-option:hover {
            background: linear-gradient(135deg, rgba(100, 179, 244, 0.2), rgba(201, 109, 216, 0.1));
            border-color: #64b3f4;
            transform: translateY(-2px);
        }

        .custom-action {
            border-top: 1px solid rgba(100, 179, 244, 0.3);
            padding-top: 1rem;
        }

        .custom-action label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #64b3f4;
        }

        .custom-action input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(100, 179, 244, 0.3);
            border-radius: 8px;
            color: white;
            margin-bottom: 0.5rem;
        }

        .custom-action input:focus {
            outline: none;
            border-color: #64b3f4;
            box-shadow: 0 0 10px rgba(100, 179, 244, 0.3);
        }

        .custom-action button {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .custom-action button:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="world-background" id="worldBackground"></div>

    <div class="header">
        <h1>üè∞ ÎçòÏ†ÑÌÜ°</h1>
        <p>AI ÎçòÏ†ÑÎßàÏä§ÌÑ∞ÏôÄ Ìï®ÍªòÌïòÎäî TRPG Î™®Ìóò</p>
    </div>

    <div class="game-container">
        <div class="chat-area">
            <div class="messages" id="messages">
                <div class="message dm">
                    üåü **ÌôòÏòÅÌï©ÎãàÎã§, Ïö©Í∞êÌïú Î™®ÌóòÍ∞Ä!**<br><br>
                    Ï†ÄÎäî Ïó¨Îü¨Î∂ÑÏùÑ Îã§ÏñëÌïú ÏÑ∏Í≥ÑÎ°ú ÏïàÎÇ¥Ìï† ÎçòÏ†ÑÎßàÏä§ÌÑ∞ÏûÖÎãàÎã§.<br><br>
                    
                    Ïö∞Ï∏°ÏóêÏÑú **ÏÑ∏Í≥ÑÍ¥Ä**ÏùÑ ÏÑ†ÌÉùÌïú ÌõÑ **ÏßÅÏóÖ**ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Î™®ÌóòÏù¥ ÏãúÏûëÎê©ÎãàÎã§!<br><br>
                    
                    üåç Ïñ¥Îñ§ ÏÑ∏Í≥ÑÏóêÏÑú Î™®ÌóòÌïòÏãúÍ≤†ÏäµÎãàÍπå?
                </div>
            </div>
            
            <div class="thinking" id="thinking">
                üé≤ ÎçòÏ†ÑÎßàÏä§ÌÑ∞Í∞Ä ÏÉùÍ∞Å Ï§ëÏûÖÎãàÎã§...
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea id="messageInput" placeholder="Î®ºÏ†Ä Ïö∞Ï∏°ÏóêÏÑú ÏÑ∏Í≥ÑÍ¥ÄÍ≥º ÏßÅÏóÖÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî..." 
                           autocomplete="off" rows="1" disabled></textarea>
                    <button id="sendButton" disabled>‚ú® Ï†ÑÏÜ°</button>
                </div>
            </div>
        </div>

        <div class="side-panel" id="sidePanel">
            <div id="worldSelection" class="world-selection">
                <h3>üåç Î™®ÌóòÌï† ÏÑ∏Í≥ÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</h3>
                <div class="world-options">
                    <div class="world-option" onclick="selectWorld('apocalypse')">
                        <div class="world-icon">üßü</div>
                        <div class="world-name">Ï¢ÄÎπÑ ÏïÑÌè¨ÏπºÎ¶ΩÏä§</div>
                        <div class="world-desc">ÌèêÌóàÍ∞Ä Îêú ÏÑ∏ÏÉÅÏóêÏÑúÏùò ÏÉùÏ°¥</div>
                    </div>
                    <div class="world-option" onclick="selectWorld('fantasy')">
                        <div class="world-icon">üè∞</div>
                        <div class="world-name">Ï†ïÌÜµ ÌåêÌÉÄÏßÄ</div>
                        <div class="world-desc">ÎßàÎ≤ïÍ≥º ÎìúÎûòÍ≥§Ïùò Ï§ëÏÑ∏ ÏÑ∏Í≥Ñ</div>
                    </div>
                    <div class="world-option" onclick="selectWorld('cyberpunk')">
                        <div class="world-icon">ü§ñ</div>
                        <div class="world-name">ÏÇ¨Ïù¥Î≤ÑÌéëÌÅ¨</div>
                        <div class="world-desc">ÎÑ§Ïò®ÏÇ¨Ïù∏ Í∞ÄÎìùÌïú ÎØ∏Îûò ÎèÑÏãú</div>
                    </div>
                    <div class="world-option" onclick="selectWorld('modern')">
                        <div class="world-icon">üåü</div>
                        <div class="world-name">ÌòÑÎåÄ ÌåêÌÉÄÏßÄ</div>
                        <div class="world-desc">ÌòÑÏã§ ÏÜç Ïà®Í≤®ÏßÑ ÎßàÎ≤ï ÏÑ∏Í≥Ñ</div>
                    </div>
                </div>
            </div>

            <div id="classSelection" class="class-selection" style="display: none;">
                <h3 id="classSelectionTitle">‚öîÔ∏è ÏßÅÏóÖ ÏÑ†ÌÉù</h3>
                <div class="class-options" id="classOptions">
                    <!-- ÏÑ∏Í≥ÑÍ¥Ä ÏÑ†ÌÉù ÌõÑ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
                </div>
            </div>

            <!-- Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ìå®ÎÑê -->
            <div id="characterPanel" class="character-panel" style="display: none;">
                <h3>üë§ Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥</h3>
                <div class="character-info">
                    <div class="character-name-level">
                        <span id="characterName">Î™®ÌóòÍ∞Ä</span>
                        <span id="characterLevel">Lv.1</span>
                    </div>
                    <div class="character-class" id="characterClass">Ï†ÑÏÇ¨</div>
                    
                    <!-- HP/MP/Ïä§ÌÉúÎØ∏ÎÇò Î∞î -->
                    <div class="stat-bars">
                        <div class="stat-bar">
                            <label>‚ù§Ô∏è HP</label>
                            <div class="bar-container">
                                <div class="bar hp-bar">
                                    <div class="bar-fill" id="hpFill" style="width: 100%"></div>
                                </div>
                                <span class="bar-text" id="hpText">100/100</span>
                            </div>
                        </div>
                        <div class="stat-bar">
                            <label>üíô MP</label>
                            <div class="bar-container">
                                <div class="bar mp-bar">
                                    <div class="bar-fill" id="mpFill" style="width: 100%"></div>
                                </div>
                                <span class="bar-text" id="mpText">50/50</span>
                            </div>
                        </div>
                        <div class="stat-bar">
                            <label>üíö Ï≤¥Î†•</label>
                            <div class="bar-container">
                                <div class="bar stamina-bar">
                                    <div class="bar-fill" id="staminaFill" style="width: 100%"></div>
                                </div>
                                <span class="bar-text" id="staminaText">100/100</span>
                            </div>
                        </div>
                        <div class="stat-bar">
                            <label>‚≠ê EXP</label>
                            <div class="bar-container">
                                <div class="bar exp-bar">
                                    <div class="bar-fill" id="expFill" style="width: 0%"></div>
                                </div>
                                <span class="bar-text" id="expText">0/100</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ïù∏Î≤§ÌÜ†Î¶¨ Ìå®ÎÑê -->
            <div id="inventoryPanel" class="inventory-panel" style="display: none;">
                <h3>üéí Ïù∏Î≤§ÌÜ†Î¶¨</h3>
                <div class="inventory-grid" id="inventoryGrid">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
                </div>
                <div class="equipment-slots">
                    <h4>Ïû•Ï∞© ÏïÑÏù¥ÌÖú</h4>
                    <div class="equipment-grid">
                        <div class="equipment-slot" id="weaponSlot">
                            <div class="slot-label">‚öîÔ∏è Î¨¥Í∏∞</div>
                            <div class="slot-item" id="equippedWeapon">ÏóÜÏùå</div>
                        </div>
                        <div class="equipment-slot" id="armorSlot">
                            <div class="slot-label">üõ°Ô∏è Î∞©Ïñ¥Íµ¨</div>
                            <div class="slot-item" id="equippedArmor">ÏóÜÏùå</div>
                        </div>
                        <div class="equipment-slot" id="accessorySlot">
                            <div class="slot-label">üíç Ïû•Ïã†Íµ¨</div>
                            <div class="slot-item" id="equippedAccessory">ÏóÜÏùå</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÌÄòÏä§Ìä∏ Ìå®ÎÑê -->
            <div id="questPanel" class="quest-panel" style="display: none;">
                <h3>üìú ÌÄòÏä§Ìä∏</h3>
                <div class="quest-list" id="questList">
                    <!-- ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± -->
                </div>
            </div>

            <!-- Ï£ºÏÇ¨ÏúÑ Í≤∞Í≥º ÌëúÏãú -->
            <div id="diceResult" class="dice-result" style="display: none;">
                <div class="dice-animation" id="diceAnimation">üé≤</div>
                <div class="dice-value" id="diceValue">20</div>
                <div class="dice-type" id="diceType">ÌÅ¨Î¶¨Ìã∞Ïª¨ ÏÑ±Í≥µ!</div>
            </div>

            <!-- AI ÏÑ†ÌÉùÏßÄ Ìå®ÎÑê -->
            <div id="choicesPanel" class="choices-panel" style="display: none;">
                <h3>üéØ ÌñâÎèô ÏÑ†ÌÉù</h3>
                <div class="choices-list" id="choicesList">
                    <!-- AIÍ∞Ä Ï†úÍ≥µÌïòÎäî ÏÑ†ÌÉùÏßÄÎì§ -->
                </div>
                <div class="custom-action">
                    <label>ÎòêÎäî ÏßÅÏ†ë ÏûÖÎ†•:</label>
                    <input type="text" id="customActionInput" placeholder="ÏõêÌïòÎäî ÌñâÎèôÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
                    <button onclick="submitCustomAction()">Ïã§Ìñâ</button>
                </div>
            </div>

            <div id="gameActions" class="game-actions" style="display: none;">
                <h3>‚ö° Í≤åÏûÑ Î©îÎâ¥</h3>
                <div class="quick-actions">
                    <div class="quick-action" onclick="togglePanel('characterPanel')">
                        üë§ Ï∫êÎ¶≠ÌÑ∞
                    </div>
                    <div class="quick-action" onclick="togglePanel('inventoryPanel')">
                        üéí Ïù∏Î≤§ÌÜ†Î¶¨
                    </div>
                    <div class="quick-action" onclick="togglePanel('questPanel')">
                        üìú ÌÄòÏä§Ìä∏
                    </div>
                    <div class="quick-action" onclick="sendQuickMessage('Ìú¥ÏãùÏùÑ Ï∑®Ìï©ÎãàÎã§')">
                        üò¥ Ìú¥Ïãù
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let isWaitingForResponse = false;
        let selectedClass = null;
        let selectedWorld = null;
        
        // Í≤åÏûÑ ÏÉÅÌÉú Í¥ÄÎ¶¨
        let gameState = {
            character: {
                name: '',
                class: '',
                level: 1,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                stamina: 100,
                maxStamina: 100,
                exp: 0,
                expToNext: 100,
                stats: {
                    strength: 10,
                    dexterity: 10,
                    intelligence: 10,
                    wisdom: 10,
                    constitution: 10,
                    charisma: 10
                }
            },
            inventory: [],
            equipment: {
                weapon: null,
                armor: null,
                accessory: null
            },
            quests: [],
            inCombat: false,
            currentChoices: []
        };

        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const thinking = document.getElementById('thinking');
        const sessionStatus = document.getElementById('sessionStatus');
        const classSelection = document.getElementById('classSelection');
        const worldSelection = document.getElementById('worldSelection');
        const gameActions = document.getElementById('gameActions');
        const worldBackground = document.getElementById('worldBackground');
        const sidePanel = document.getElementById('sidePanel');
        const chatArea = document.querySelector('.chat-area');

        // ÏÑ∏Í≥ÑÍ¥ÄÎ≥Ñ Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ URL
        const worldBackgrounds = {
            apocalypse: '/images/apocalypse-bg.png',
            fantasy: '/images/fantasy-bg.png',
            cyberpunk: '/images/cyberpunk-bg.png',
            modern: '/images/modern-bg.png'
        };

        // ÏÑ∏Í≥ÑÍ¥ÄÎ≥Ñ ÏßÅÏóÖ Ï†ïÎ≥¥
        const worldClasses = {
            apocalypse: {
                warrior: { name: 'ÏÉùÏ°¥Ïûê', icon: 'üõ°Ô∏è', desc: 'Ï†ÑÌà¨ Í≤ΩÌóòÏù¥ ÌíçÎ∂ÄÌïú ÏÉùÏ°¥Ïûê. Í∑ºÏ†ë Î¨¥Í∏∞ÏôÄ Î∞©Ïñ¥Íµ¨Ïóê ÌäπÌôîÎêòÏñ¥ ÏûàÏúºÎ©∞, Ï¢ÄÎπÑ Î¨¥Î¶¨ÏôÄÏùò Ï†ÑÌà¨ÏóêÏÑú ÌÉÅÏõîÌïú Îä•Î†•ÏùÑ Î≥¥ÏûÖÎãàÎã§.' },
                mage: { name: 'Í≥ºÌïôÏûê', icon: 'üß™', desc: 'ÌôîÌïô ÏßÄÏãùÏùÑ ÌôúÏö©Ìï¥ Ìè≠Î∞úÎ¨ºÍ≥º ÎèÖÏÑ± Î¨ºÏßàÏùÑ Ï†úÏ°∞Ìï† Ïàò ÏûàÏäµÎãàÎã§. Î∞©ÏÇ¨Îä• ÏßÄÏó≠ÏóêÏÑúÏùò ÏÉùÏ°¥ Îä•Î†•Ïù¥ Îõ∞Ïñ¥ÎÇ©ÎãàÎã§.' },
                rogue: { name: 'Ïä§Ïπ¥Î≤§Ï†Ä', icon: 'üîç', desc: 'ÌèêÌóàÏóêÏÑú Ïú†Ïö©Ìïú Î¨ºÍ±¥ÏùÑ Ï∞æÏïÑÎÇ¥Îäî Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§. ÏùÄÎ∞ÄÌïú Ïù¥ÎèôÍ≥º Ìä∏Îû© Ï†úÏûëÏóê Îä•ÏàôÌï©ÎãàÎã§.' },
                cleric: { name: 'ÏùòÎ£åÏßÑ', icon: 'üè•', desc: 'ÏùëÍ∏âÏ≤òÏπòÏôÄ Ïã¨Î¶¨Ï†Å ÏπòÎ£åÏóê ÌäπÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§. ÏÉùÏ°¥ÏûêÎì§Ïùò Ï†ïÏã†Ï†Å ÏßÄÏ£º Ïó≠Ìï†ÏùÑ Ìï©ÎãàÎã§.' }
            },
            fantasy: {
                warrior: { name: 'Í∏∞ÏÇ¨', icon: '‚öîÔ∏è', desc: 'Í≤ÄÍ≥º Î∞©Ìå®Î•º Îì† Ïö©ÎßπÌïú Í∏∞ÏÇ¨. Í∞ïÎ†•Ìïú Î¨ºÎ¶¨ Í≥µÍ≤©Î†•Í≥º ÎÜíÏùÄ Î∞©Ïñ¥Î†•ÏùÑ Í∞ÄÏßÄÍ≥† ÏûàÏúºÎ©∞, Ï†ÑÏû•ÏóêÏÑú ÎèôÎ£åÎì§ÏùÑ Î≥¥Ìò∏Ìï©ÎãàÎã§.' },
                mage: { name: 'ÎßàÎ≤ïÏÇ¨', icon: 'üîÆ', desc: 'Í≥†ÎåÄ ÎßàÎ≤ïÏÑúÎ•º Ïó∞Íµ¨ÌïòÎäî ÌòÑÏûê. Í∞ïÎ†•Ìïú ÏõêÏÜå ÎßàÎ≤ïÏùÑ Íµ¨ÏÇ¨ÌïòÎ©∞, Ïã†ÎπÑÎ°úÏö¥ ÏßÄÏãùÏúºÎ°ú ÌçºÏ¶êÏùÑ Ìï¥Í≤∞Ìï©ÎãàÎã§.' },
                rogue: { name: 'ÎèÑÏ†Å', icon: 'üó°Ô∏è', desc: 'Í∑∏Î¶ºÏûê ÏÜçÏóê Ïà®Ïñ¥ Ï†ÅÏùò Í∏âÏÜåÎ•º ÎÖ∏Î¶¨Îäî ÏïîÏÇ¥Ïûê. Îπ†Î•∏ ÏÜçÎèÑÏôÄ ÏùÄÏã† Îä•Î†•ÏúºÎ°ú Ï†ïÎ≥¥Î•º ÏàòÏßëÌïòÍ≥† Ìï®Ï†ïÏùÑ Ìï¥Ï†úÌï©ÎãàÎã§.' },
                cleric: { name: 'ÏÑ±ÏßÅÏûê', icon: '‚ú®', desc: 'Ïã†Ïùò Í∞ÄÌò∏Î•º Î∞õÏùÄ ÏÑ±Ïä§Îü¨Ïö¥ ÏπòÏú†ÏÇ¨. Ïã†ÏÑ± ÎßàÎ≤ïÏúºÎ°ú ÎèôÎ£åÎ•º ÏπòÏú†ÌïòÍ≥† Ïñ∏Îç∞ÎìúÎ•º Ìá¥ÏπòÌï©ÎãàÎã§.' }
            },
            cyberpunk: {
                warrior: { name: 'ÏÇ¨Ïù¥Î≤Ñ Ïö©Î≥ë', icon: 'ü¶æ', desc: 'ÏÇ¨Ïù¥Î≤ÑÎÑ§Ìã± Í∞ïÌôîÎ•º Î∞õÏùÄ Ïö©Î≥ë. Ï≤®Îã® Î¨¥Í∏∞ÏôÄ Ïù∏Í≥µ Í∑ºÏú°ÏúºÎ°ú Í∞ïÌôîÎêú Ïã†Ï≤¥Î•º Í∞ÄÏßÄÍ≥† ÏûàÏäµÎãàÎã§.' },
                mage: { name: 'Ìï¥Ïª§', icon: 'üíª', desc: 'ÏÇ¨Ïù¥Î≤Ñ Í≥µÍ∞ÑÏùÑ ÏûêÏú†ÏûêÏû¨Î°ú Ï°∞ÏûëÌï©ÎãàÎã§. AIÏôÄ ÏÜåÌÜµÌïòÍ≥† ÏãúÏä§ÌÖúÏùÑ Ìï¥ÌÇπÌïòÎäî Îä•Î†•Ïù¥ Îõ∞Ïñ¥ÎÇ©ÎãàÎã§.' },
                rogue: { name: 'ÏÇ¨Ïù¥Î≤Ñ ÎãåÏûê', icon: 'üë§', desc: 'Í¥ëÌïô ÏúÑÏû•Í≥º Ïã†Í≤Ω Í∞ÑÏÑ≠ ÏûÑÌîåÎûÄÌä∏Î•º ÏÇ¨Ïö©Ìï¥ ÏôÑÎ≤ΩÌïú ÏùÄÏã†Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.' },
                cleric: { name: 'Ïä§Ìä∏Î¶¨Ìä∏ Îã•ÌÑ∞', icon: 'üß¨', desc: 'ÏùòÎ£åÏö© ÎÇòÎÖ∏Î¥áÍ≥º Î∞îÏù¥Ïò§ Ìï¥ÌÇπÏúºÎ°ú ÏÉÅÏ≤òÎ•º ÏπòÎ£åÌïòÍ≥† ÎèÖÏÜåÎ•º Ï†úÍ±∞Ìï©ÎãàÎã§.' }
            },
            modern: {
                warrior: { name: 'ÌóåÌÑ∞', icon: 'üéØ', desc: 'ÌäπÏàòÎ∂ÄÎåÄ Ï∂úÏã†ÏúºÎ°ú ÌòÑÎåÄ Î¨¥Í∏∞ÏôÄ Ï†ÑÏà†Ïóê Îä•ÌÜµÌï©ÎãàÎã§. Ï¥àÏûêÏó∞Ï†Å Ï°¥Ïû¨ÏôÄ ÎßûÏÑúÎäî Ï†ÑÎ¨∏ ÌóåÌÑ∞ÏûÖÎãàÎã§.' },
                mage: { name: 'ÎîîÏßÄÌÑ∏ ÎßàÎ≤ïÏÇ¨', icon: 'üì±', desc: 'ÎèÑÏãú ÏÜçÏóê Ïà®Ïñ¥ ÏÇ¨Îäî ÌòÑÎåÄÏùò ÎßàÎ≤ïÏÇ¨. Ïä§ÎßàÌä∏Ìè∞Í≥º Ïª¥Ìì®ÌÑ∞Î•º ÌÜµÌï¥ ÎîîÏßÄÌÑ∏ ÎßàÎ≤ïÏùÑ Íµ¨ÏÇ¨Ìï©ÎãàÎã§.' },
                rogue: { name: 'Í¥¥ÎèÑ', icon: 'üïµÔ∏è', desc: 'ÎèÑÏãúÏùò Í∑∏Î¶ºÏûêÎ•º ÎàÑÎπÑÎäî ÌòÑÎåÄÏùò Í¥¥ÎèÑ. CCTVÎ•º ÌîºÌïòÍ≥† Î≥¥Ïïà ÏãúÏä§ÌÖúÏùÑ Î¨¥Î†•ÌôîÌïòÎäî Ï†ÑÎ¨∏Í∞ÄÏûÖÎãàÎã§.' },
                cleric: { name: 'ÏóëÏÜåÏãúÏä§Ìä∏', icon: 'üôè', desc: 'Ï¢ÖÍµêÏ†Å ÏßÄÏãùÍ≥º ÌòÑÎåÄ Í∏∞Ïà†ÏùÑ Í≤∞Ìï©Ìï¥ ÏïÖÎ†πÏùÑ Ìá¥ÏπòÌï©ÎãàÎã§.' }
            }
        };

        // üé≤ Ï£ºÏÇ¨ÏúÑ ÏãúÏä§ÌÖú
        function rollDice(sides = 20) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function showDiceResult(value, type = 'normal') {
            const diceResult = document.getElementById('diceResult');
            const diceAnimation = document.getElementById('diceAnimation');
            const diceValue = document.getElementById('diceValue');
            const diceType = document.getElementById('diceType');

            diceValue.textContent = value;
            
            let resultText = '';
            let resultClass = '';
            
            if (value === 20) {
                resultText = 'ÌÅ¨Î¶¨Ìã∞Ïª¨ ÏÑ±Í≥µ!';
                resultClass = 'critical-success';
            } else if (value === 1) {
                resultText = 'ÌÅ¨Î¶¨Ìã∞Ïª¨ Ïã§Ìå®!';
                resultClass = 'critical-failure';
            } else if (value >= 15) {
                resultText = 'ÎåÄÏÑ±Í≥µ!';
                resultClass = 'success';
            } else if (value >= 10) {
                resultText = 'ÏÑ±Í≥µ';
                resultClass = 'success';
            } else {
                resultText = 'Ïã§Ìå®';
                resultClass = 'failure';
            }
            
            diceType.textContent = resultText;
            diceType.className = `dice-type ${resultClass}`;
            
            diceResult.style.display = 'block';
            
            // 3Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ
            setTimeout(() => {
                diceResult.style.display = 'none';
            }, 3000);
            
            return { value, type: resultClass, text: resultText };
        }

        // üìä Ï∫êÎ¶≠ÌÑ∞ Ïä§ÌÉØ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCharacterStats() {
            document.getElementById('characterName').textContent = gameState.character.name || 'Î™®ÌóòÍ∞Ä';
            document.getElementById('characterLevel').textContent = `Lv.${gameState.character.level}`;
            document.getElementById('characterClass').textContent = gameState.character.class;
            
            // HP Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const hpPercentage = (gameState.character.hp / gameState.character.maxHp) * 100;
            document.getElementById('hpFill').style.width = `${hpPercentage}%`;
            document.getElementById('hpText').textContent = `${gameState.character.hp}/${gameState.character.maxHp}`;
            
            // MP Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const mpPercentage = (gameState.character.mp / gameState.character.maxMp) * 100;
            document.getElementById('mpFill').style.width = `${mpPercentage}%`;
            document.getElementById('mpText').textContent = `${gameState.character.mp}/${gameState.character.maxMp}`;
            
            // Ïä§ÌÉúÎØ∏ÎÇò Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const staminaPercentage = (gameState.character.stamina / gameState.character.maxStamina) * 100;
            document.getElementById('staminaFill').style.width = `${staminaPercentage}%`;
            document.getElementById('staminaText').textContent = `${gameState.character.stamina}/${gameState.character.maxStamina}`;
            
            // Í≤ΩÌóòÏπò Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            const expPercentage = (gameState.character.exp / gameState.character.expToNext) * 100;
            document.getElementById('expFill').style.width = `${expPercentage}%`;
            document.getElementById('expText').textContent = `${gameState.character.exp}/${gameState.character.expToNext}`;
        }

        // üéí Ïù∏Î≤§ÌÜ†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
        function updateInventory() {
            const inventoryGrid = document.getElementById('inventoryGrid');
            inventoryGrid.innerHTML = '';
            
            // Ïù∏Î≤§ÌÜ†Î¶¨ Ïä¨Î°Ø ÏÉùÏÑ± (16Í∞ú Ïä¨Î°Ø)
            for (let i = 0; i < 16; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                
                if (gameState.inventory[i]) {
                    const item = gameState.inventory[i];
                    slot.innerHTML = `<div style="text-align: center;">
                        <div style="font-size: 1.5rem;">${item.icon}</div>
                        <div style="font-size: 0.7rem;">${item.name}</div>
                    </div>`;
                    slot.onclick = () => useItem(i);
                } else {
                    slot.innerHTML = '<div style="opacity: 0.3;">Îπà Ïä¨Î°Ø</div>';
                }
                
                inventoryGrid.appendChild(slot);
            }
            
            // Ïû•Ï∞© ÏïÑÏù¥ÌÖú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('equippedWeapon').textContent = 
                gameState.equipment.weapon ? gameState.equipment.weapon.name : 'ÏóÜÏùå';
            document.getElementById('equippedArmor').textContent = 
                gameState.equipment.armor ? gameState.equipment.armor.name : 'ÏóÜÏùå';
            document.getElementById('equippedAccessory').textContent = 
                gameState.equipment.accessory ? gameState.equipment.accessory.name : 'ÏóÜÏùå';
        }

        // üìú ÌÄòÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
        function updateQuests() {
            const questList = document.getElementById('questList');
            questList.innerHTML = '';
            
            if (gameState.quests.length === 0) {
                questList.innerHTML = '<div style="text-align: center; opacity: 0.6;">ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ ÌÄòÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</div>';
                return;
            }
            
            gameState.quests.forEach((quest, index) => {
                const questItem = document.createElement('div');
                questItem.className = 'quest-item';
                questItem.innerHTML = `
                    <div class="quest-title">${quest.title}</div>
                    <div class="quest-description">${quest.description}</div>
                    <div class="quest-progress">ÏßÑÌñâÎ•†: ${quest.progress}/${quest.maxProgress}</div>
                `;
                questList.appendChild(questItem);
            });
        }

        // üéØ ÏÑ†ÌÉùÏßÄ ÏãúÏä§ÌÖú
        function showChoices(choices) {
            const choicesPanel = document.getElementById('choicesPanel');
            const choicesList = document.getElementById('choicesList');
            
            choicesList.innerHTML = '';
            
            choices.forEach((choice, index) => {
                const choiceOption = document.createElement('div');
                choiceOption.className = 'choice-option';
                choiceOption.innerHTML = choice;
                choiceOption.onclick = () => selectChoice(index, choice);
                choicesList.appendChild(choiceOption);
            });
            
            gameState.currentChoices = choices;
            choicesPanel.style.display = 'block';
        }

        function selectChoice(index, choice) {
            document.getElementById('choicesPanel').style.display = 'none';
            sendMessage(choice);
        }

        function submitCustomAction() {
            const customInput = document.getElementById('customActionInput');
            const action = customInput.value.trim();
            
            if (action) {
                document.getElementById('choicesPanel').style.display = 'none';
                customInput.value = '';
                sendMessage(action);
            }
        }

        // üéÆ Ìå®ÎÑê ÌÜ†Í∏Ä Ìï®Ïàò
        function togglePanel(panelId) {
            const panels = ['characterPanel', 'inventoryPanel', 'questPanel'];
            
            panels.forEach(id => {
                const panel = document.getElementById(id);
                if (id === panelId) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                } else {
                    panel.style.display = 'none';
                }
            });
        }

        // üîß Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
        function addItemToInventory(item) {
            for (let i = 0; i < 16; i++) {
                if (!gameState.inventory[i]) {
                    gameState.inventory[i] = item;
                    updateInventory();
                    return true;
                }
            }
            return false; // Ïù∏Î≤§ÌÜ†Î¶¨ Í∞ÄÎìùÏ∞∏
        }

        function useItem(slotIndex) {
            const item = gameState.inventory[slotIndex];
            if (!item) return;
            
            // ÏïÑÏù¥ÌÖú ÏÇ¨Ïö© Î°úÏßÅ
            if (item.type === 'consumable') {
                // ÏÜåÎ™®Ìíà ÏÇ¨Ïö©
                if (item.effect === 'heal') {
                    gameState.character.hp = Math.min(gameState.character.maxHp, gameState.character.hp + item.value);
                    addMessage(`${item.name}Î•º ÏÇ¨Ïö©ÌïòÏó¨ HPÍ∞Ä ${item.value} ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§!`, 'system');
                }
                gameState.inventory[slotIndex] = null;
            } else if (item.type === 'equipment') {
                // Ïû•ÎπÑ ÏïÑÏù¥ÌÖú
                equipItem(item, slotIndex);
            }
            
            updateInventory();
            updateCharacterStats();
        }

        function equipItem(item, slotIndex) {
            const slot = item.slot; // 'weapon', 'armor', 'accessory'
            
            // Í∏∞Ï°¥ Ïû•Ï∞© ÏïÑÏù¥ÌÖúÏù¥ ÏûàÎã§Î©¥ Ïù∏Î≤§ÌÜ†Î¶¨Î°ú
            if (gameState.equipment[slot]) {
                const emptySlot = findEmptyInventorySlot();
                if (emptySlot !== -1) {
                    gameState.inventory[emptySlot] = gameState.equipment[slot];
                }
            }
            
            // ÏÉà ÏïÑÏù¥ÌÖú Ïû•Ï∞©
            gameState.equipment[slot] = item;
            gameState.inventory[slotIndex] = null;
            
            addMessage(`${item.name}ÏùÑ(Î•º) Ïû•Ï∞©ÌñàÏäµÎãàÎã§!`, 'system');
        }

        function findEmptyInventorySlot() {
            for (let i = 0; i < 16; i++) {
                if (!gameState.inventory[i]) return i;
            }
            return -1;
        }

        // Î©îÏãúÏßÄ Ï†ÑÏÜ° Ìï®Ïàò (Ï£ºÏÇ¨ÏúÑ ÏãúÏä§ÌÖú ÌÜµÌï©)
        async function sendMessage(message) {
            if (isWaitingForResponse || !message.trim()) return;

            // Ï£ºÏÇ¨ÏúÑ Íµ¥Î¶¨Í∏∞ (Î™®Îì† ÌñâÎèôÏóê ÎåÄÌï¥)
            const diceRoll = rollDice(20);
            const diceResult = showDiceResult(diceRoll);
            
            isWaitingForResponse = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Ï†ÑÏÜ° Ï§ë...';

            // ÌîåÎ†àÏù¥Ïñ¥ Î©îÏãúÏßÄ ÌëúÏãú (Ï£ºÏÇ¨ÏúÑ Í≤∞Í≥º Ìè¨Ìï®)
            addMessage(`${message} <br><small style="color: #64b3f4;">[Ï£ºÏÇ¨ÏúÑ: ${diceRoll} - ${diceResult.text}]</small>`, 'player');
            
            // ÏÉùÍ∞Å Ï§ë ÌëúÏãú
            thinking.classList.add('show');
            
            // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
            messageInput.value = '';
            
            try {
                const url = currentSessionId 
                    ? '/api/chat/message' 
                    : '/api/chat/start';
                
                const params = new URLSearchParams();
                
                // Í≤åÏûÑ Ïª®ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥ Ìè¨Ìï® (Ï£ºÏÇ¨ÏúÑ Í≤∞Í≥ºÏôÄ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÌÉú Ìè¨Ìï®)
                if (selectedWorld && selectedClass) {
                    const contextMessage = `[Í≤åÏûÑ ÏÉÅÌÉú] 
ÏÑ∏Í≥ÑÍ¥Ä: ${getWorldName(selectedWorld)}
ÏßÅÏóÖ: ${selectedClass}
Î†àÎ≤®: ${gameState.character.level}
HP: ${gameState.character.hp}/${gameState.character.maxHp}
MP: ${gameState.character.mp}/${gameState.character.maxMp}
Ï£ºÏÇ¨ÏúÑ Í≤∞Í≥º: ${diceRoll} (${diceResult.text})

ÌîåÎ†àÏù¥Ïñ¥ ÌñâÎèô: ${message}

ÎçòÏ†ÑÎßàÏä§ÌÑ∞Îäî Ï£ºÏÇ¨ÏúÑ Í≤∞Í≥ºÎ•º Î∞òÏòÅÌïòÏó¨ ÏÉÅÌô©ÏùÑ Ìï¥ÏÑùÌïòÍ≥†, ÌïÑÏöîÏãú Ï∫êÎ¶≠ÌÑ∞ Ïä§ÌÉØ Î≥ÄÌôîÎÇò ÏïÑÏù¥ÌÖú ÌöçÎìù, ÌÄòÏä§Ìä∏ ÏßÑÌñâ Îì±ÏùÑ JSON ÌòïÌÉúÎ°ú ÏùëÎãµ ÎÅùÏóê Ìè¨Ìï®Ìï¥Ï£ºÏÑ∏Ïöî.
Ïòà: [GAME_UPDATE]{"hp": -10, "exp": +25, "item": {"name": "Ï≤¥Î†• Ìè¨ÏÖò", "icon": "üß™", "type": "consumable"}}`;
                    params.append('message', contextMessage);
                } else {
                    params.append('message', message);
                }
                
                if (currentSessionId) {
                    params.append('sessionId', currentSessionId);
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // ÏÑ∏ÏÖò ID ÏóÖÎç∞Ïù¥Ìä∏ (ÏÉà ÏÑ∏ÏÖòÏù∏ Í≤ΩÏö∞)
                if (!currentSessionId) {
                    currentSessionId = `session_${Date.now()}`;
                    sessionStatus.textContent = 'ÌôúÏÑ± ÏÑ∏ÏÖò';
                }

                // DM ÏùëÎãµ Ï≤òÎ¶¨ Î∞è Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏
                if (data.text) {
                    processAIResponse(data.text);
                } else {
                    addMessage('Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÏùëÎãµÏùÑ Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'dm');
                }

            } catch (error) {
                console.error('Error:', error);
                
                // API Ìï†ÎãπÎüâ Ï¥àÍ≥º Ïò§Î•ò Ï≤òÎ¶¨
                if (error.message.includes('429') || error.message.includes('quota') || error.message.includes('Too Many Requests')) {
                    addMessage('‚ö†Ô∏è **API Ìï†ÎãπÎüâ Ï¥àÍ≥º**<br><br>Ï£ÑÏÜ°Ìï©ÎãàÎã§. Ïò§ÎäòÏùò AI API ÏÇ¨Ïö©ÎüâÏùÑ Î™®Îëê ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.<br><br>üîÑ **Ìï¥Í≤∞ Î∞©Î≤ï:**<br>‚Ä¢ ÎÇ¥Ïùº Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî (ÏûêÏ†ïÏóê Î¶¨ÏÖã)<br>‚Ä¢ ÎòêÎäî ÏÉàÎ°úÏö¥ API ÌÇ§Î°ú ÍµêÏ≤¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§<br><br>Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî! üôè', 'dm');
                } else {
                    addMessage('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'dm');
                }
            } finally {
                isWaitingForResponse = false;
                sendButton.disabled = false;
                sendButton.textContent = '‚ú® Ï†ÑÏÜ°';
                thinking.classList.remove('show');
            }
        }

        // ÏÑ∏Í≥ÑÍ¥Ä Ïù¥Î¶Ñ Î∞òÌôò Ìï®Ïàò
        function getWorldName(worldType) {
            const names = {
                apocalypse: 'Ï¢ÄÎπÑ ÏïÑÌè¨ÏπºÎ¶ΩÏä§',
                fantasy: 'Ï†ïÌÜµ ÌåêÌÉÄÏßÄ',
                cyberpunk: 'ÏÇ¨Ïù¥Î≤ÑÌéëÌÅ¨',
                modern: 'ÌòÑÎåÄ ÌåêÌÉÄÏßÄ'
            };
            return names[worldType];
        }

        // AI ÏùëÎãµ Ï≤òÎ¶¨ (Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏ Ìè¨Ìï®)
        function processAIResponse(responseText) {
            let displayText = responseText;
            
            // Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏ JSON Ï∂îÏ∂ú (Ï§ëÏ≤©Îêú JSON Íµ¨Ï°∞ Ï≤òÎ¶¨)
            const gameUpdateIndex = responseText.indexOf('[GAME_UPDATE]');
            if (gameUpdateIndex !== -1) {
                try {
                    // [GAME_UPDATE] Îí§Ïùò JSON Î∂ÄÎ∂Ñ Ï∞æÍ∏∞
                    const jsonStart = gameUpdateIndex + '[GAME_UPDATE]'.length;
                    let braceCount = 0;
                    let jsonEnd = -1;
                    
                    for (let i = jsonStart; i < responseText.length; i++) {
                        if (responseText[i] === '{') {
                            braceCount++;
                        } else if (responseText[i] === '}') {
                            braceCount--;
                            if (braceCount === 0) {
                                jsonEnd = i + 1;
                                break;
                            }
                        }
                    }
                    
                    if (jsonEnd !== -1) {
                        const jsonStr = responseText.substring(jsonStart, jsonEnd);
                        const gameUpdate = JSON.parse(jsonStr);
                        applyGameUpdate(gameUpdate);
                        
                        // ÏùëÎãµ ÌÖçÏä§Ìä∏ÏóêÏÑú Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏ Î∂ÄÎ∂Ñ ÏôÑÏ†ÑÌûà Ï†úÍ±∞
                        displayText = responseText.substring(0, gameUpdateIndex) + 
                                    responseText.substring(jsonEnd);
                        displayText = displayText.trim();
                    }
                } catch (error) {
                    console.error('Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏ ÌååÏã± Ïò§Î•ò:', error, responseText);
                    // Ïò§Î•ò Ïãú Í∞ÑÎã®Ìïú Î∞©Î≤ïÏúºÎ°ú Ï†úÍ±∞
                    displayText = responseText.replace(/\[GAME_UPDATE\].*$/, '').trim();
                }
            }
            
            // ÏÑ†ÌÉùÏßÄ Ï∂îÏ∂ú
            const choicesMatch = displayText.match(/\[CHOICES\]\[(.*?)\]/);
            if (choicesMatch) {
                try {
                    const choices = JSON.parse('[' + choicesMatch[1] + ']');
                    showChoices(choices);
                    
                    // ÏùëÎãµ ÌÖçÏä§Ìä∏ÏóêÏÑú ÏÑ†ÌÉùÏßÄ Î∂ÄÎ∂Ñ Ï†úÍ±∞
                    displayText = displayText.replace(/\[CHOICES\]\[.*?\]/, '').trim();
                } catch (error) {
                    console.error('ÏÑ†ÌÉùÏßÄ ÌååÏã± Ïò§Î•ò:', error);
                }
            }
            
            // Îπà ÏùëÎãµÏù¥ ÏïÑÎãê ÎïåÎßå Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            if (displayText && displayText.length > 0) {
                addMessage(displayText, 'dm');
            }
        }

        // Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏ Ï†ÅÏö©
        function applyGameUpdate(update) {
            let updateMessages = [];
            
            // HP Î≥ÄÌôî
            if (update.hp) {
                gameState.character.hp = Math.max(0, Math.min(gameState.character.maxHp, gameState.character.hp + update.hp));
                if (update.hp > 0) {
                    updateMessages.push(`HPÍ∞Ä ${update.hp} ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§!`);
                } else {
                    updateMessages.push(`${Math.abs(update.hp)}Ïùò ÌîºÌï¥Î•º ÏûÖÏóàÏäµÎãàÎã§!`);
                }
            }
            
            // MP Î≥ÄÌôî
            if (update.mp) {
                gameState.character.mp = Math.max(0, Math.min(gameState.character.maxMp, gameState.character.mp + update.mp));
                if (update.mp > 0) {
                    updateMessages.push(`MPÍ∞Ä ${update.mp} ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§!`);
                } else {
                    updateMessages.push(`MPÎ•º ${Math.abs(update.mp)} ÏÜåÎ™®ÌñàÏäµÎãàÎã§!`);
                }
            }
            
            // Í≤ΩÌóòÏπò ÌöçÎìù
            if (update.exp) {
                gameState.character.exp += update.exp;
                updateMessages.push(`Í≤ΩÌóòÏπò ${update.exp}Î•º ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                
                // Î†àÎ≤®ÏóÖ Ï≤¥ÌÅ¨
                if (gameState.character.exp >= gameState.character.expToNext) {
                    levelUp();
                }
            }
            
            // ÏïÑÏù¥ÌÖú ÌöçÎìù (Îã®Ïùº ÏïÑÏù¥ÌÖú ÎòêÎäî Î∞∞Ïó¥ Ï≤òÎ¶¨)
            if (update.item) {
                const items = Array.isArray(update.item) ? update.item : [update.item];
                
                items.forEach(item => {
                    if (addItemToInventory(item)) {
                        updateMessages.push(`${item.name}ÏùÑ(Î•º) ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                    } else {
                        updateMessages.push(`Ïù∏Î≤§ÌÜ†Î¶¨Í∞Ä Í∞ÄÎìù Ï∞®ÏÑú ${item.name}ÏùÑ(Î•º) ÌöçÎìùÌï† Ïàò ÏóÜÏäµÎãàÎã§!`);
                    }
                });
            }
            
            // ÌÄòÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            if (update.quest) {
                if (update.quest.new) {
                    gameState.quests.push(update.quest.new);
                    updateMessages.push(`ÏÉàÎ°úÏö¥ ÌÄòÏä§Ìä∏: ${update.quest.new.title}`);
                }
                if (update.quest.complete) {
                    gameState.quests = gameState.quests.filter(q => q.id !== update.quest.complete);
                    updateMessages.push(`ÌÄòÏä§Ìä∏ ÏôÑÎ£å!`);
                }
            }
            
            // ÏóÖÎç∞Ïù¥Ìä∏ Î©îÏãúÏßÄ ÌëúÏãú
            if (updateMessages.length > 0) {
                addMessage(`üìä **Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏**<br>${updateMessages.join('<br>')}`, 'system');
            }
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateCharacterStats();
            updateInventory();
            updateQuests();
        }

        // Î†àÎ≤®ÏóÖ Ï≤òÎ¶¨
        function levelUp() {
            gameState.character.level++;
            gameState.character.exp -= gameState.character.expToNext;
            gameState.character.expToNext = Math.floor(gameState.character.expToNext * 1.5);
            
            // Ïä§ÌÉØ Ï¶ùÍ∞Ä
            gameState.character.maxHp += 20;
            gameState.character.hp = gameState.character.maxHp; // Î†àÎ≤®ÏóÖ Ïãú Ï≤¥Î†• ÏôÑÏ†Ñ ÌöåÎ≥µ
            gameState.character.maxMp += 10;
            gameState.character.mp = gameState.character.maxMp;
            
            addMessage(`üéâ **Î†àÎ≤®ÏóÖ!** Lv.${gameState.character.level}Ïù¥ ÎêòÏóàÏäµÎãàÎã§!<br>HPÏôÄ MPÍ∞Ä ÏôÑÏ†ÑÌûà ÌöåÎ≥µÎêòÏóàÏäµÎãàÎã§!`, 'system');
        }

        // Î©îÏãúÏßÄ Ï∂îÍ∞Ä Ìï®Ïàò
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Ï§ÑÎ∞îÍøà Ï≤òÎ¶¨ Î∞è Î¨∏Îã® ÎÇòÎàÑÍ∏∞
            const formattedText = text
                .replace(/\n/g, '<br>')
                .replace(/\. ([A-ZÍ∞Ä-Ìû£])/g, '.<br><br>$1')
                .replace(/([?!]) ([A-ZÍ∞Ä-Ìû£])/g, '$1<br><br>$2');
            
            messageDiv.innerHTML = formattedText;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Îπ†Î•∏ Î©îÏãúÏßÄ Ï†ÑÏÜ°
        function sendQuickMessage(message) {
            if (!isWaitingForResponse) {
                messageInput.value = message;
                sendMessage(message);
            }
        }

        // ÏÑ∏Í≥ÑÍ¥Ä ÏÑ†ÌÉù Ìï®Ïàò
        function selectWorld(worldType) {
            selectedWorld = worldType;
            
            // Î™®Îì† ÏÑ∏Í≥ÑÍ¥Ä ÏòµÏÖòÏóêÏÑú selected ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.world-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // ÏÑ†ÌÉùÎêú ÏÑ∏Í≥ÑÍ¥ÄÏóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            event.target.closest('.world-option').classList.add('selected');
            
            // ÌÖåÎßà Î≥ÄÍ≤Ω
            document.body.className = `theme-${worldType}`;
            
            // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω
            worldBackground.style.backgroundImage = `url(${worldBackgrounds[worldType]})`;
            worldBackground.classList.add('active');
            
            // ÏÑ∏Í≥ÑÍ¥Ä ÏÑ†ÌÉù ÌõÑ ÏßÅÏóÖ ÏÑ†ÌÉùÏúºÎ°ú Ïù¥Îèô
            setTimeout(() => {
                worldSelection.style.display = 'none';
                showClassSelection(worldType);
            }, 500);
        }

        // ÏÑ∏Í≥ÑÍ¥ÄÎ≥Ñ ÏßÅÏóÖ ÏÑ†ÌÉù UI ÏÉùÏÑ±
        function showClassSelection(worldType) {
            const classes = worldClasses[worldType];
            const classOptions = document.getElementById('classOptions');
            const title = document.getElementById('classSelectionTitle');
            
            // ÏÑ∏Í≥ÑÍ¥ÄÏóê ÎßûÎäî ÌÉÄÏù¥ÌãÄ ÏÑ§Ï†ï
            const worldNames = {
                apocalypse: 'üßü ÏÉùÏ°¥Ïûê ÏßÅÏóÖ ÏÑ†ÌÉù',
                fantasy: 'üè∞ Î™®ÌóòÍ∞Ä ÏßÅÏóÖ ÏÑ†ÌÉù', 
                cyberpunk: 'ü§ñ ÏÇ¨Ïù¥Î≤Ñ ÏßÅÏóÖ ÏÑ†ÌÉù',
                modern: 'üåü ÌòÑÎåÄ ÏßÅÏóÖ ÏÑ†ÌÉù'
            };
            title.textContent = worldNames[worldType];
            
            // ÏßÅÏóÖ ÏòµÏÖò ÎèôÏ†Å ÏÉùÏÑ±
            classOptions.innerHTML = '';
            Object.keys(classes).forEach(classKey => {
                const classInfo = classes[classKey];
                const classOption = document.createElement('div');
                classOption.className = 'class-option';
                classOption.onclick = () => selectClass(classKey, classInfo.name);
                
                classOption.innerHTML = `
                    <div class="class-icon">${classInfo.icon}</div>
                    <div class="class-name">${classInfo.name}</div>
                    <div class="class-desc">${classInfo.desc}</div>
                `;
                
                classOptions.appendChild(classOption);
            });
            
            classSelection.style.display = 'block';
        }

        // ÏßÅÏóÖ ÏÑ†ÌÉù Ìï®Ïàò
        function selectClass(classKey, className) {
            selectedClass = className;
            
            // Î™®Îì† ÏßÅÏóÖ ÏòµÏÖòÏóêÏÑú selected ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.class-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // ÏÑ†ÌÉùÎêú ÏßÅÏóÖÏóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            event.target.closest('.class-option').classList.add('selected');
            
            // ÏßÅÏóÖ ÏÑ†ÌÉù ÌõÑ Î∞îÎ°ú Í≤åÏûÑ ÏãúÏûë
            setTimeout(() => {
                startGame(classKey, className);
            }, 300);
        }

        // Í≤åÏûÑ ÏãúÏûë Ìï®Ïàò
        function startGame(classKey, className) {
            const classInfo = worldClasses[selectedWorld][classKey];
            
            // ÏÑ∏Í≥ÑÍ¥Ä Ïù¥ÎØ∏ÏßÄ Ï†ÑÏ≤¥ÌôîÎ©¥ÏúºÎ°ú 7Ï¥à ÌëúÏãú
            showWorldIntroScreen(classKey, className, classInfo);
        }

        // ÏÑ∏Í≥ÑÍ¥Ä ÏÜåÍ∞ú ÌôîÎ©¥ ÌëúÏãú
        function showWorldIntroScreen(classKey, className, classInfo) {
            // Ï†ÑÏ≤¥ÌôîÎ©¥ Ïò§Î≤ÑÎ†àÏù¥ ÏÉùÏÑ±
            const introOverlay = document.createElement('div');
            introOverlay.className = 'world-intro-overlay';
            introOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url(${worldBackgrounds[selectedWorld]});
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
            `;

            // Ïò§Î≤ÑÎ†àÏù¥ ÎÇ¥Ïö©
            const introContent = document.createElement('div');
            introContent.style.cssText = `
                text-align: center;
                background: rgba(0, 0, 0, 0.7);
                padding: 3rem;
                border-radius: 20px;
                backdrop-filter: blur(10px);
                color: white;
                max-width: 600px;
            `;
            
            introContent.innerHTML = `
                <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: #64b3f4;">
                    ${getWorldName(selectedWorld)}
                </h2>
                <p style="font-size: 1.2rem; margin-bottom: 2rem; line-height: 1.6;">
                    ${getWorldIntroduction(selectedWorld)}
                </p>
                <div style="font-size: 1.5rem; color: #c96dd8;">
                    ÏßÅÏóÖ: ${className}
                </div>
                <div style="margin-top: 2rem; font-size: 1rem; opacity: 0.8;">
                    Î™®ÌóòÏù¥ Í≥ß ÏãúÏûëÎê©ÎãàÎã§...
                </div>
            `;

            introOverlay.appendChild(introContent);
            document.body.appendChild(introOverlay);

            // ÌéòÏù¥Îìú Ïù∏
            setTimeout(() => {
                introOverlay.style.opacity = '1';
            }, 100);

            // 7Ï¥à ÌõÑ Í≤åÏûÑ ÏãúÏûë
            setTimeout(() => {
                // ÌéòÏù¥Îìú ÏïÑÏõÉ
                introOverlay.style.opacity = '0';
                
                setTimeout(() => {
                    document.body.removeChild(introOverlay);
                    startGameAfterIntro(classKey, className, classInfo);
                }, 500);
            }, 7000);
        }

        // ÏÜåÍ∞ú ÌôîÎ©¥ ÌõÑ Ïã§Ï†ú Í≤åÏûÑ ÏãúÏûë
        function startGameAfterIntro(classKey, className, classInfo) {
            // Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
            initializeCharacter(className, classInfo);
            
            // Î†àÏù¥ÏïÑÏõÉÏùÑ Í≤åÏûÑ Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω
            sidePanel.classList.add('game-mode');
            
            // ÏÇ¨Ïù¥Îìú Ìå®ÎÑê ÎÇ¥Ïö© Î≥ÄÍ≤Ω
            classSelection.style.display = 'none';
            document.getElementById('characterPanel').style.display = 'block';
            gameActions.style.display = 'block';
            
            // ÏûÖÎ†•Ï∞Ω ÌôúÏÑ±Ìôî
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = "ÎçòÏ†ÑÎßàÏä§ÌÑ∞ÏóêÍ≤å ÎßêÏùÑ Í±∏Ïñ¥Î≥¥ÏÑ∏Ïöî... (Ïòà: Ï£ºÎ≥ÄÏùÑ ÏÇ¥Ìé¥Î¥ÖÎãàÎã§)";
            messageInput.focus();
            
            // Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú
            messagesContainer.innerHTML = `
                <div class="message dm">
                    üé≤ ÎçòÏ†ÑÎßàÏä§ÌÑ∞Í∞Ä ${getWorldName(selectedWorld)} ÏÑ∏Í≥ÑÎ•º Ï§ÄÎπÑÌïòÍ≥† ÏûàÏäµÎãàÎã§...<br>
                    Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî!
                </div>
            `;
            
            // Ï¥àÍ∏∞ ÏïÑÏù¥ÌÖú ÏßÄÍ∏â
            giveStartingItems(selectedWorld, classKey);
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateCharacterStats();
            updateInventory();
            updateQuests();
            
            // AIÏóêÍ≤å Í≤åÏûÑ ÏãúÏûëÌïòÎùºÍ≥† ÏöîÏ≤≠ÌïòÍ≥† Ïã§Ï†ú ÏùëÎãµ Î∞õÍ∏∞
            setTimeout(() => {
                startGameWithAI(className, classInfo);
            }, 500);
        }

        // Ï∫êÎ¶≠ÌÑ∞ Ï¥àÍ∏∞Ìôî
        function initializeCharacter(className, classInfo) {
            gameState.character.name = 'Î™®ÌóòÍ∞Ä';
            gameState.character.class = className;
            gameState.character.level = 1;
            gameState.character.hp = 100;
            gameState.character.maxHp = 100;
            gameState.character.mp = 50;
            gameState.character.maxMp = 50;
            gameState.character.stamina = 100;
            gameState.character.maxStamina = 100;
            gameState.character.exp = 0;
            gameState.character.expToNext = 100;
        }

        // ÏãúÏûë ÏïÑÏù¥ÌÖú ÏßÄÍ∏â
        function giveStartingItems(worldType, classKey) {
            const startingItems = {
                apocalypse: {
                    warrior: [
                        { name: 'ÏùëÍ∏âÏ≤òÏπò ÌÇ§Ìä∏', icon: 'üè•', type: 'consumable', effect: 'heal', value: 30 },
                        { name: 'ÎÖπÏä® Ïπº', icon: 'üó°Ô∏è', type: 'equipment', slot: 'weapon', damage: 15 }
                    ],
                    mage: [
                        { name: 'ÏóêÎÑàÏßÄ ÎìúÎßÅÌÅ¨', icon: '‚ö°', type: 'consumable', effect: 'mp', value: 20 },
                        { name: 'ÌôîÌïô Ïû•ÎπÑ', icon: 'üß™', type: 'equipment', slot: 'weapon', damage: 12 }
                    ],
                    rogue: [
                        { name: 'Ï≤¥Î†• Ìè¨ÏÖò', icon: '‚ù§Ô∏è', type: 'consumable', effect: 'heal', value: 25 },
                        { name: 'Îã§Î™©Ï†Å ÎèÑÍµ¨', icon: 'üîß', type: 'equipment', slot: 'weapon', damage: 10 }
                    ],
                    cleric: [
                        { name: 'ÏùòÎ£åÏö© Î∂ïÎåÄ', icon: 'ü©π', type: 'consumable', effect: 'heal', value: 40 },
                        { name: 'ÏùòÎ£å Í∞ÄÎ∞©', icon: 'üíä', type: 'equipment', slot: 'accessory', bonus: 'healing+5' }
                    ]
                },
                fantasy: {
                    warrior: [
                        { name: 'Ï≤¥Î†• Ìè¨ÏÖò', icon: '‚ù§Ô∏è', type: 'consumable', effect: 'heal', value: 30 },
                        { name: 'Ï≤† Í≤Ä', icon: '‚öîÔ∏è', type: 'equipment', slot: 'weapon', damage: 20 }
                    ],
                    mage: [
                        { name: 'ÎßàÎÇò Ìè¨ÏÖò', icon: 'üíô', type: 'consumable', effect: 'mp', value: 25 },
                        { name: 'ÎßàÎ≤ï ÏßÄÌå°Ïù¥', icon: 'ü™Ñ', type: 'equipment', slot: 'weapon', damage: 15, magic: true }
                    ],
                    rogue: [
                        { name: 'Ìï¥ÎèÖÏ†ú', icon: 'üß™', type: 'consumable', effect: 'heal', value: 20 },
                        { name: 'Îã®Í≤Ä', icon: 'üó°Ô∏è', type: 'equipment', slot: 'weapon', damage: 18, speed: true }
                    ],
                    cleric: [
                        { name: 'ÏÑ±Ïàò', icon: 'üíß', type: 'consumable', effect: 'heal', value: 35 },
                        { name: 'ÏÑ±Ïä§Îü¨Ïö¥ Î∂ÄÏ†Å', icon: 'üìø', type: 'equipment', slot: 'accessory', bonus: 'protection+3' }
                    ]
                }
            };

            // Í∏∞Î≥∏ ÏïÑÏù¥ÌÖú (Î™®Îì† ÏßÅÏóÖ Í≥µÌÜµ)
            addItemToInventory({ name: 'Îπµ', icon: 'üçû', type: 'consumable', effect: 'heal', value: 15 });
            
            // ÏÑ∏Í≥ÑÍ¥ÄÍ≥º ÏßÅÏóÖÎ≥Ñ ÏãúÏûë ÏïÑÏù¥ÌÖú
            if (startingItems[worldType] && startingItems[worldType][classKey]) {
                startingItems[worldType][classKey].forEach(item => {
                    addItemToInventory(item);
                });
            }
        }

        // AIÏôÄ Ìï®Íªò Í≤åÏûÑ ÏãúÏûëÌïòÎäî Ìï®Ïàò 
        async function startGameWithAI(className, classInfo) {
            const startMessage = `[Í≤åÏûÑ ÏãúÏûë] ÏÑ∏Í≥ÑÍ¥Ä: ${getWorldName(selectedWorld)}, ÌîåÎ†àÏù¥Ïñ¥ ÏßÅÏóÖ: ${className}, ÏßÅÏóÖ Îä•Î†•: ${classInfo.desc}. 

ÏßÄÍ∏àÎ∂ÄÌÑ∞ Ïù¥ ÏÑ§Ï†ïÏóê ÎßûÎäî TRPG ÎçòÏ†ÑÎßàÏä§ÌÑ∞Í∞Ä ÎêòÏñ¥Ï£ºÏÑ∏Ïöî. ÌîåÎ†àÏù¥Ïñ¥Î•º ÌôòÏòÅÌïòÍ≥† ÌòÑÏû¨ ÏÉÅÌô©ÏùÑ ÏÉùÏÉùÌïòÍ≤å Î¨òÏÇ¨ÌïòÎ©∞ Î™®ÌóòÏùÑ ÏãúÏûëÌï¥Ï£ºÏÑ∏Ïöî. ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ïñ¥Îñ§ ÌñâÎèôÏùÑ Ìï†ÏßÄ Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî.`;

            try {
                const url = '/api/chat/start';
                const params = new URLSearchParams();
                params.append('message', startMessage);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // ÏÑ∏ÏÖò ID ÏÉùÏÑ±
                currentSessionId = `session_${Date.now()}`;
                
                // AI ÏùëÎãµÏùÑ ÌôîÎ©¥Ïóê ÌëúÏãú
                messagesContainer.innerHTML = '';
                if (data.text) {
                    addMessage(data.text, 'dm');
                } else {
                    addMessage('ÎçòÏ†ÑÎßàÏä§ÌÑ∞Í∞Ä Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'dm');
                }

            } catch (error) {
                console.error('Game start error:', error);
                
                // Ïò§Î•ò Ïãú Í∏∞Î≥∏ Î©îÏãúÏßÄ ÌëúÏãú
                messagesContainer.innerHTML = '';
                if (error.message.includes('429') || error.message.includes('quota')) {
                    addMessage('‚ö†Ô∏è **API Ìï†ÎãπÎüâ Ï¥àÍ≥º**<br><br>Ï£ÑÏÜ°Ìï©ÎãàÎã§. Ïò§ÎäòÏùò AI API ÏÇ¨Ïö©ÎüâÏùÑ Î™®Îëê ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§.<br><br>üîÑ **Ìï¥Í≤∞ Î∞©Î≤ï:**<br>‚Ä¢ ÎÇ¥Ïùº Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî (ÏûêÏ†ïÏóê Î¶¨ÏÖã)<br>‚Ä¢ ÎòêÎäî ÏÉàÎ°úÏö¥ API ÌÇ§Î°ú ÍµêÏ≤¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§<br><br>Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî! üôè', 'dm');
                } else {
                    addMessage('ÎçòÏ†ÑÎßàÏä§ÌÑ∞ Ïó∞Í≤∞Ïóê Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.', 'dm');
                }
            }
        }

        // ÏÑ∏Í≥ÑÍ¥ÄÎ≥Ñ ÏÜåÍ∞ú ÌÖçÏä§Ìä∏
        function getWorldIntroduction(worldType) {
            const introductions = {
                apocalypse: 'ÌïµÏ†ÑÏüÅ Ïù¥ÌõÑ 20ÎÖÑÏù¥ ÏßÄÎÇú Ìô©ÌèêÌïú ÏÑ∏ÏÉÅÏûÖÎãàÎã§. Ï¢ÄÎπÑÎì§Ïù¥ Í±∞Î¶¨Î•º Î∞∞ÌöåÌïòÍ≥†, ÏÉùÏ°¥ÏûêÎì§ÏùÄ ÌèêÌóà ÏÜçÏóêÏÑú ÌïòÎ£®ÌïòÎ£®Î•º Î≤ÑÌÖ®ÎÇòÍ∞ÄÍ≥† ÏûàÏäµÎãàÎã§.',
                fantasy: 'ÎßàÎ≤ïÍ≥º Í≤ÄÏù¥ ÏßÄÎ∞∞ÌïòÎäî Ï§ëÏÑ∏ ÌåêÌÉÄÏßÄ ÏÑ∏Í≥ÑÏûÖÎãàÎã§. Ïö©Îì§Ïù¥ ÌïòÎäòÏùÑ ÎÇ†Í≥†, Í≥†ÎåÄÏùò ÎßàÎ≤ïÏù¥ ÏÇ¥ÏïÑ Ïà®Ïâ¨Îäî Ïã†ÎπÑÎ°úÏö¥ ÎïÖÏûÖÎãàÎã§.',
                cyberpunk: '2085ÎÖÑ ÎÑ§Ïò§ ÎèÑÏøÑÏûÖÎãàÎã§. Í±∞ÎåÄ Í∏∞ÏóÖÎì§Ïù¥ ÏÑ∏ÏÉÅÏùÑ ÏßÄÎ∞∞ÌïòÍ≥†, ÏÇ¨Ïù¥Î≤Ñ Í≥µÍ∞ÑÍ≥º ÌòÑÏã§Ïùò Í≤ΩÍ≥ÑÍ∞Ä Î™®Ìò∏Ìïú ÎØ∏Îûò ÎèÑÏãúÏûÖÎãàÎã§.',
                modern: 'Í≤âÎ≥¥Í∏∞Ïóî ÌèâÎ≤îÌïú ÌòÑÎåÄ ÎèÑÏãúÏù¥ÏßÄÎßå, Í∑∏ Ïù¥Î©¥ÏóêÎäî Ï¥àÏûêÏó∞Ï†ÅÏù∏ Ï°¥Ïû¨Îì§Í≥º Ïà®Í≤®ÏßÑ ÎßàÎ≤ï ÏÑ∏Í≥ÑÍ∞Ä Ï°¥Ïû¨Ìï©ÎãàÎã§.'
            };
            return introductions[worldType];
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏÑ∏Í≥ÑÍ¥Ä Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
        function initializeWorldOptions() {
            const worldOptions = document.querySelectorAll('.world-option');
            worldOptions.forEach((option, index) => {
                const worldTypes = ['apocalypse', 'fantasy', 'cyberpunk', 'modern'];
                const worldType = worldTypes[index];
                if (worldBackgrounds[worldType]) {
                    option.style.setProperty('--bg-image', `url(${worldBackgrounds[worldType]})`);
                    option.addEventListener('mouseenter', () => {
                        option.style.backgroundImage = `url(${worldBackgrounds[worldType]})`;
                        option.style.backgroundSize = 'cover';
                        option.style.backgroundPosition = 'center';
                        option.style.backgroundBlendMode = 'overlay';
                    });
                    option.addEventListener('mouseleave', () => {
                        if (!option.classList.contains('selected')) {
                            option.style.backgroundImage = '';
                        }
                    });
                }
            });
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        sendButton.addEventListener('click', () => {
            sendMessage(messageInput.value);
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(messageInput.value);
            }
        });

        // ÏûêÎèô ÎÜíÏù¥ Ï°∞Ï†à
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
        });

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî
        window.addEventListener('load', () => {
            initializeWorldOptions();
            // Í≤åÏûÑ ÏãúÏûë ÌõÑÏóêÎßå ÏûÖÎ†•Ï∞ΩÏóê Ìè¨Ïª§Ïä§
        });
    </script>
</body>
</html>